<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Dynamic Layout App ‚Äî JSON Driven</title>

<!-- Plotly pour les graphiques -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

<style>
  body {
    margin: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #f6faf8 0%, #e8f4f0 100%);
    color: #003c26;
    transition: all 0.3s ease;
    min-height: 100vh;
  }

  .app {
    display: grid;
    grid-template-columns: 280px 1fr;
    height: 100vh;
    overflow: hidden;
  }

  /* LEFT PANEL - SIDEBAR */
  .sidebar {
    background: linear-gradient(180deg, #007348 0%, #00a678 100%);
    color: white;
    padding: 20px;
    display: flex;
    flex-direction: column;
    box-shadow: 4px 0 15px rgba(0, 60, 38, 0.1);
    z-index: 100;
  }

  .sidebar h2 {
    margin-top: 0;
    margin-bottom: 25px;
    color: white;
    font-size: 18px;
    padding-bottom: 12px;
    border-bottom: 2px solid rgba(141, 201, 171, 0.5);
    font-weight: 600;
    letter-spacing: 0.5px;
  }

  /* Navigation */
  .nav-item {
    background: rgba(0, 146, 91, 0.8);
    padding: 14px 18px;
    border-radius: 8px;
    margin-bottom: 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border: 2px solid transparent;
    font-weight: 500;
    font-size: 15px;
  }

  .nav-item:hover {
    background: rgba(0, 156, 109, 0.9);
    transform: translateY(-3px) scale(1.02);
    box-shadow: 0 5px 15px rgba(0, 60, 38, 0.2);
  }

  .nav-item.active {
    border-color: #8dc9ab;
    background: #007348;
    box-shadow: 0 4px 12px rgba(0, 115, 72, 0.3);
  }

  .nav-icon {
    width: 22px;
    height: 22px;
    margin-right: 12px;
    filter: brightness(0) invert(1);
  }

  /* Pages list */
  .pages-list {
    margin-top: 30px;
    flex-grow: 1;
    overflow-y: auto;
    padding-right: 8px;
  }

  .pages-list::-webkit-scrollbar {
    width: 6px;
  }

  .pages-list::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 3px;
  }

  .pages-list::-webkit-scrollbar-thumb {
    background: rgba(141, 201, 171, 0.6);
    border-radius: 3px;
  }

  .page-item {
    background: rgba(0, 146, 91, 0.8);
    margin-bottom: 10px;
    padding: 16px;
    border-radius: 8px;
    cursor: pointer;
    border: 2px solid transparent;
    transition: all 0.3s;
    position: relative;
    padding-right: 40px;
    animation: slideIn 0.3s ease-out;
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateX(-20px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  .page-item:hover {
    background: rgba(0, 156, 109, 0.9);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 60, 38, 0.15);
  }

  .page-item.active {
    border-color: #8dc9ab;
    background: #007348;
    box-shadow: 0 4px 12px rgba(0, 115, 72, 0.25);
  }

  .page-title {
    font-weight: 600;
    margin-bottom: 6px;
    font-size: 14.5px;
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 6px;
  }

  .page-tag {
    display: inline-block;
    background: rgba(255, 255, 255, 0.25);
    padding: 3px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 500;
    letter-spacing: 0.3px;
    text-transform: uppercase;
  }

  .page-date {
    font-size: 12px;
    color: #8dc9ab;
    opacity: 0.9;
  }

  .delete-page {
    position: absolute;
    top: 12px;
    right: 12px;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.15);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.2s;
    font-weight: bold;
  }

  .delete-page:hover {
    background: rgba(255, 255, 255, 0.25);
    transform: scale(1.15);
  }

  /* MAIN CONTENT */
  .main-content {
    padding: 30px 40px;
    overflow-y: auto;
    background: white;
    position: relative;
  }

  .main-content::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #007348 0%, #00a678 50%, #8dc9ab 100%);
  }

  .panel-title {
    font-size: 28px;
    margin-bottom: 25px;
    color: #007348;
    padding-bottom: 15px;
    border-bottom: 2px solid #8dc9ab;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .panel-title::before {
    content: 'üìä';
    font-size: 32px;
  }

  /* Configuration styles */
  .level-container {
    margin-bottom: 30px;
    padding: 24px;
    background: linear-gradient(135deg, #f9fdfb 0%, #f0f9f5 100%);
    border-radius: 12px;
    border-left: 5px solid #009c6d;
    box-shadow: 0 4px 15px rgba(0, 115, 72, 0.08);
    transition: transform 0.3s ease;
  }

  .level-container:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 115, 72, 0.12);
  }

  .level-title {
    font-size: 20px;
    font-weight: 700;
    color: #007348;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .level-title::before {
    content: 'üîΩ';
    font-size: 18px;
  }

  .control-group {
    margin-bottom: 20px;
  }

  .control-group label {
    display: block;
    margin-bottom: 10px;
    font-weight: 600;
    color: #007348;
    font-size: 15.5px;
  }

  .control-group label.required::after {
    content: " *";
    color: #ff4444;
    font-weight: bold;
  }

  select, input[type="text"], input[type="number"], input[type="email"], input[type="date"], input[type="password"] {
    padding: 12px 16px;
    width: 100%;
    max-width: 450px;
    border: 2px solid #8dc9ab;
    border-radius: 8px;
    font-size: 15px;
    transition: all 0.3s;
    background: white;
    box-shadow: 0 2px 5px rgba(0, 60, 38, 0.05);
  }

  select.error, input.error {
    border-color: #ff4444;
    background-color: #fff9f9;
    animation: shake 0.5s;
  }

  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
  }

  select:focus, input:focus {
    outline: none;
    border-color: #00a678;
    box-shadow: 0 0 0 4px rgba(0, 166, 120, 0.15);
    transform: translateY(-1px);
  }

  .error-message {
    color: #ff4444;
    font-size: 13.5px;
    margin-top: 6px;
    display: none;
    padding: 8px 12px;
    background: rgba(255, 68, 68, 0.05);
    border-radius: 6px;
    border-left: 3px solid #ff4444;
  }

  .error-message.show {
    display: block;
    animation: fadeIn 0.3s;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-5px); }
    to { opacity: 1; transform: translateY(0); }
  }

  button {
    padding: 14px 28px;
    background: linear-gradient(135deg, #009c6d 0%, #00a678 100%);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
    font-weight: 600;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    min-width: 160px;
    margin-top: 12px;
    letter-spacing: 0.5px;
    position: relative;
    overflow: hidden;
  }

  button::after {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: 0.5s;
  }

  button:hover {
    background: linear-gradient(135deg, #007348 0%, #009c6d 100%);
    transform: translateY(-3px);
    box-shadow: 0 7px 20px rgba(0, 115, 72, 0.3);
  }

  button:hover::after {
    left: 100%;
  }

  button.submit-btn {
    background: linear-gradient(135deg, #007348 0%, #00925b 100%);
    font-size: 16.5px;
    padding: 15px 32px;
    margin-top: 25px;
  }

  button.submit-btn::before {
    content: 'üöÄ ';
    margin-right: 8px;
  }

  button.reset-btn {
    background: linear-gradient(135deg, #8dc9ab 0%, #a8d9c3 100%);
    color: #003c26;
    font-size: 16px;
    padding: 15px 32px;
    margin-top: 25px;
    margin-left: 15px;
  }

  button.reset-btn::before {
    content: 'üîÑ ';
    margin-right: 8px;
  }

  .checkbox-group, .radio-group {
    margin-top: 12px;
  }

  .checkbox-group label, .radio-group label {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
    padding: 12px;
    background: white;
    border-radius: 8px;
    border: 2px solid #8dc9ab;
    cursor: pointer;
    transition: all 0.2s;
  }

  .checkbox-group label:hover, .radio-group label:hover {
    background: #f0f9f5;
    transform: translateX(5px);
  }

  .checkbox-group input, .radio-group input {
    margin-right: 12px;
    width: auto;
    transform: scale(1.2);
  }

  .checkbox-group.error, .radio-group.error {
    border-color: #ff4444;
    background-color: rgba(255, 68, 68, 0.05);
  }

  /* Popup for missing mandatory fields */
  .popup-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2000;
    backdrop-filter: blur(4px);
    animation: fadeIn 0.3s;
  }

  .popup-content {
    background: white;
    padding: 35px;
    border-radius: 16px;
    max-width: 500px;
    width: 90%;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    animation: slideUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }

  @keyframes slideUp {
    from {
      opacity: 0;
      transform: translateY(50px) scale(0.9);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  .popup-title {
    color: #ff4444;
    font-size: 22px;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    font-weight: 700;
  }

  .popup-title::before {
    content: "‚ö†Ô∏è";
    margin-right: 12px;
    font-size: 26px;
  }

  .popup-message {
    margin-bottom: 25px;
    line-height: 1.7;
    color: #555;
  }

  .popup-list {
    margin: 20px 0;
    padding-left: 25px;
  }

  .popup-list li {
    margin-bottom: 10px;
    color: #003c26;
    padding: 8px 0;
    border-bottom: 1px solid #eee;
  }

  .popup-list li:last-child {
    border-bottom: none;
  }

  .popup-buttons {
    display: flex;
    justify-content: flex-end;
    margin-top: 30px;
  }

  .popup-btn {
    padding: 12px 24px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    font-size: 15px;
    transition: all 0.2s;
  }

  .popup-btn.ok {
    background: linear-gradient(135deg, #007348 0%, #009c6d 100%);
    color: white;
    border: none;
    min-width: 100px;
  }

  .popup-btn.ok:hover {
    background: linear-gradient(135deg, #00925b 0%, #00a678 100%);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 115, 72, 0.3);
  }

  /* Visualization styles */
  .chart-container, .table-container, .comment-box-container {
    background: linear-gradient(135deg, #f9fdfb 0%, #f0f9f5 100%);
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 30px;
    border-left: 5px solid #009c6d;
    box-shadow: 0 4px 15px rgba(0, 115, 72, 0.08);
    transition: transform 0.3s ease;
  }

  .chart-container:hover, .table-container:hover, .comment-box-container:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0, 115, 72, 0.12);
  }

  .chart-title, .table-title, .comment-title {
    font-size: 20px;
    font-weight: 700;
    color: #007348;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .chart-title::before {
    content: 'üìà';
  }

  .table-title::before {
    content: 'üìã';
  }

  .comment-title::before {
    content: 'üí¨';
  }

  .chart-content {
    height: 300px;
    background: white;
    border-radius: 10px;
    padding: 20px;
    border: 2px solid #8dc9ab;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow: hidden;
  }

  .chart-content::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #007348, #00a678, #8dc9ab);
  }

  .data-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    background: white;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 3px 10px rgba(0, 60, 38, 0.1);
  }

  .data-table th {
    background: linear-gradient(135deg, #009c6d 0%, #00a678 100%);
    color: white;
    padding: 16px 20px;
    text-align: left;
    font-weight: 600;
    font-size: 15px;
  }

  .data-table td {
    padding: 14px 20px;
    border-bottom: 1px solid #e8f4f0;
    transition: background 0.2s;
  }

  .data-table tr:hover {
    background: #f0f9f5;
  }

  .data-table tr:last-child td {
    border-bottom: none;
  }

  .comment-content {
    background: white;
    border-radius: 10px;
    padding: 25px;
    border: 2px solid #8dc9ab;
    line-height: 1.7;
    font-size: 15px;
  }

  .metric-card {
    background: linear-gradient(135deg, #f9fdfb 0%, #f0f9f5 100%);
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 30px;
    border-left: 5px solid #009c6d;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 20px;
    box-shadow: 0 4px 15px rgba(0, 115, 72, 0.08);
  }

  .metric-item {
    background: white;
    border-radius: 10px;
    padding: 25px;
    border: 2px solid #8dc9ab;
    text-align: center;
    transition: all 0.3s;
    position: relative;
    overflow: hidden;
  }

  .metric-item::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #007348, #00a678);
  }

  .metric-item:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0, 115, 72, 0.15);
  }

  .metric-value {
    font-size: 36px;
    font-weight: 800;
    color: #007348;
    margin: 15px 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }

  .metric-label {
    font-size: 15px;
    color: #666;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  /* Configuration summary in visualization */
  .config-summary {
    background: linear-gradient(135deg, #f0f9f5 0%, #e0f2e9 100%);
    border-radius: 12px;
    padding: 20px 25px;
    margin-bottom: 30px;
    border-left: 5px solid #00a678;
    box-shadow: 0 4px 15px rgba(0, 115, 72, 0.08);
  }

  .config-summary-title {
    font-size: 18px;
    font-weight: 700;
    color: #007348;
    margin-bottom: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .summary-content {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
  }

  .summary-tag {
    background: white;
    padding: 8px 15px;
    border-radius: 25px;
    font-size: 13.5px;
    border: 2px solid #8dc9ab;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s;
  }

  .summary-tag:hover {
    background: #f0f9f5;
    transform: translateY(-2px);
    box-shadow: 0 3px 10px rgba(0, 115, 72, 0.1);
  }

  .summary-label {
    font-weight: 700;
    color: #007348;
  }

  .reuse-btn {
    background: linear-gradient(135deg, #00a678 0%, #009c6d 100%);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.2s;
  }

  .reuse-btn:hover {
    background: linear-gradient(135deg, #007348 0%, #00925b 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 115, 72, 0.2);
  }

  /* Page selection styles */
  .page-selection-container {
    margin-top: 25px;
    padding: 25px;
    background: linear-gradient(135deg, #f0f9f5 0%, #e0f2e9 100%);
    border-radius: 12px;
    border-left: 5px solid #00a678;
    box-shadow: 0 4px 15px rgba(0, 115, 72, 0.08);
  }

  .page-selection-title {
    font-size: 20px;
    font-weight: 700;
    color: #007348;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .page-selection-title::before {
    content: 'üìÑ';
  }

  .page-options {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .page-option {
    display: flex;
    align-items: center;
    padding: 16px 20px;
    background: white;
    border-radius: 10px;
    border: 2px solid #8dc9ab;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
  }

  .page-option::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 4px;
    background: #00a678;
    opacity: 0;
    transition: opacity 0.3s;
  }

  .page-option:hover {
    background: #f0f9f5;
    transform: translateY(-3px);
    box-shadow: 0 5px 20px rgba(0, 115, 72, 0.1);
  }

  .page-option:hover::before {
    opacity: 1;
  }

  .page-option.selected {
    border-color: #00a678;
    background: #e0f2e9;
    box-shadow: 0 4px 15px rgba(0, 166, 120, 0.15);
  }

  .page-option input {
    margin-right: 15px;
    width: 20px;
    height: 20px;
    cursor: pointer;
  }

  .page-option-label {
    font-weight: 700;
    color: #007348;
    margin-bottom: 5px;
    font-size: 15.5px;
  }

  .page-option-description {
    font-size: 13.5px;
    color: #666;
    line-height: 1.5;
  }

  /* Selection controls */
  .selection-controls {
    display: flex;
    gap: 12px;
    margin-top: 20px;
  }

  .selection-controls button {
    padding: 10px 20px;
    font-size: 14.5px;
    min-width: auto;
    margin-top: 0;
  }

  /* Loading animation */
  .loading-spinner {
    display: none;
    text-align: center;
    padding: 40px;
  }

  .loading-spinner.active {
    display: block;
  }

  .spinner {
    width: 60px;
    height: 60px;
    border: 5px solid #e8f4f0;
    border-top: 5px solid #00a678;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  /* Responsive design */
  @media (max-width: 1024px) {
    .app {
      grid-template-columns: 250px 1fr;
    }
    
    .main-content {
      padding: 25px;
    }
  }

  @media (max-width: 768px) {
    .app {
      grid-template-columns: 1fr;
      grid-template-rows: auto 1fr;
    }
    
    .sidebar {
      padding: 15px;
      max-height: 250px;
      overflow-y: auto;
    }
    
    .main-content {
      padding: 20px;
    }
    
    .panel-title {
      font-size: 24px;
    }
    
    .metric-card {
      grid-template-columns: 1fr;
    }
  }

  /* Notification toast */
  .toast {
    position: fixed;
    bottom: 30px;
    right: 30px;
    background: #007348;
    color: white;
    padding: 16px 24px;
    border-radius: 10px;
    box-shadow: 0 10px 30px rgba(0, 60, 38, 0.3);
    transform: translateY(100px);
    opacity: 0;
    transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    z-index: 1000;
    max-width: 400px;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .toast.show {
    transform: translateY(0);
    opacity: 1;
  }

  .toast.success {
    background: linear-gradient(135deg, #009c6d 0%, #007348 100%);
  }

  .toast.error {
    background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%);
  }

  .toast.info {
    background: linear-gradient(135deg, #00a678 0%, #00925b 100%);
  }
</style>
</head>

<body>
<div class="app">
  
  <!-- LEFT PANEL - SIDEBAR -->
  <div class="sidebar">
    <h2>Navigation</h2>
    
    <div class="nav-item active" id="configNav">
      <svg class="nav-icon" viewBox="0 0 24 24" fill="white">
        <path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 00.12-.61l-1.92-3.32a.488.488 0 00-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 00-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 00-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
      </svg>
      Configuration
    </div>
    
    <div class="pages-list">
      <h2>Generated Pages</h2>
      <div id="pagesList">
        <!-- Pages will be dynamically added here -->
        <div class="page-item">
          <div class="delete-page">√ó</div>
          <div class="page-title">
            Performance Dashboard
            <span class="page-tag">Last 7 days</span>
          </div>
          <div class="page-date">15/01/2024 14:30</div>
        </div>
        
        <div class="page-item">
          <div class="delete-page">√ó</div>
          <div class="page-title">
            User Analytics
            <span class="page-tag">Active Users</span>
          </div>
          <div class="page-date">14/01/2024 11:15</div>
        </div>
        
        <div class="page-item">
          <div class="delete-page">√ó</div>
          <div class="page-title">
            Sales Report
            <span class="page-tag">Q4 2023</span>
          </div>
          <div class="page-date">13/01/2024 16:45</div>
        </div>
      </div>
    </div>
  </div>

  <!-- MAIN CONTENT -->
  <div class="main-content" id="contentArea">
    <!-- Initial content - Configuration Interface -->
    <div class="loading-spinner" id="loadingSpinner">
      <div class="spinner"></div>
      <p>Loading configurations...</p>
    </div>
    
    <div id="initialContent" style="display: none;">
      <h1 class="panel-title">Configuration Dashboard</h1>
      <p style="color: #666; margin-bottom: 25px; font-size: 16px; line-height: 1.6;">
        Welcome to the JSON-Driven Dashboard Generator. Configure settings to generate dynamic pages with charts, tables, and metrics.
        <span style="color: #ff4444; font-weight: 600;">*</span> indicates mandatory fields.
      </p>

      <div class="level-container" id="level1-container">
        <div class="level-title">Level 1: Configuration Type</div>
        <div class="control-group">
          <label class="required">Select configuration type</label>
          <select id="level1">
            <option value="">‚Äî Please select ‚Äî</option>
            <option value="analytics">üìä Performance Analysis</option>
            <option value="userData">üë• User Data Analytics</option>
            <option value="systemMetrics">‚öôÔ∏è System Monitoring</option>
            <option value="salesData">üí∞ Sales & Revenue</option>
          </select>
          <div class="error-message" id="level1-error">Please select a configuration type</div>
        </div>
      </div>

      <div id="levelsContainer"></div>
      
      <!-- Connection status indicator -->
      <div id="connectionStatus" style="margin-top: 30px; padding: 15px; background: #f0f9f5; border-radius: 8px; display: flex; align-items: center; gap: 10px;">
        <div id="statusIndicator" style="width: 12px; height: 12px; border-radius: 50%; background: #00a678; animation: pulse 2s infinite;"></div>
        <span style="color: #007348; font-weight: 500;">Connected to API server</span>
      </div>
    </div>
  </div>
</div>

<!-- Popup for missing mandatory fields -->
<div id="mandatoryPopup" class="popup-overlay" style="display: none;">
  <div class="popup-content">
    <div class="popup-title">Mandatory Fields Required</div>
    <div class="popup-message">
      The following mandatory fields must be filled before generating the page:
    </div>
    <ul id="missingFieldsList" class="popup-list"></ul>
    <div class="popup-buttons">
      <button class="popup-btn ok" onclick="closeMandatoryPopup()">OK</button>
    </div>
  </div>
</div>

<!-- Toast notification -->
<div id="toast" class="toast" style="display: none;">
  <span id="toastIcon">‚úÖ</span>
  <span id="toastMessage">Operation completed successfully</span>
</div>

<script>
// Configuration
const API_BASE_URL = 'http://localhost:5000/api';
const APP_VERSION = '1.0.0';

// State variables
let currentLevel1 = null;
let currentSelections = {};
let currentLevels = {};
let savedConfigurations = [];
let selectedPages = {};
let availableConfigs = {};
let isApiConnected = false;

// ==================== 1. UTILITY FUNCTIONS ====================

function showToast(message, type = 'success') {
  const toast = document.getElementById('toast');
  const toastIcon = document.getElementById('toastIcon');
  const toastMessage = document.getElementById('toastMessage');
  
  toast.className = `toast ${type}`;
  toastMessage.textContent = message;
  
  switch(type) {
    case 'success':
      toastIcon.textContent = '‚úÖ';
      break;
    case 'error':
      toastIcon.textContent = '‚ùå';
      break;
    case 'info':
      toastIcon.textContent = '‚ÑπÔ∏è';
      break;
  }
  
  toast.style.display = 'flex';
  setTimeout(() => {
    toast.classList.add('show');
  }, 10);
  
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => {
      toast.style.display = 'none';
    }, 500);
  }, 3000);
}

function showLoading(show) {
  const loadingSpinner = document.getElementById('loadingSpinner');
  const initialContent = document.getElementById('initialContent');
  
  if (show) {
    loadingSpinner.classList.add('active');
    initialContent.style.display = 'none';
  } else {
    loadingSpinner.classList.remove('active');
    initialContent.style.display = 'block';
  }
}

// ==================== 2. API COMMUNICATION ====================

async function testApiConnection() {
  try {
    const response = await fetch(`${API_BASE_URL}/health`, { timeout: 5000 });
    isApiConnected = response.ok;
    updateConnectionStatus();
    return response.ok;
  } catch (error) {
    isApiConnected = false;
    updateConnectionStatus();
    return false;
  }
}

function updateConnectionStatus() {
  const statusIndicator = document.getElementById('statusIndicator');
  const statusText = document.querySelector('#connectionStatus span');
  
  if (isApiConnected) {
    statusIndicator.style.background = '#00a678';
    statusIndicator.style.animation = 'pulse 2s infinite';
    statusText.textContent = 'Connected to API server';
  } else {
    statusIndicator.style.background = '#ff4444';
    statusIndicator.style.animation = 'none';
    statusText.textContent = 'Offline mode - using local configurations';
    showToast('Running in offline mode', 'info');
  }
}

async function loadConfigurationsFromApi() {
  try {
    const response = await fetch(`${API_BASE_URL}/configurations`);
    if (response.ok) {
      return await response.json();
    }
  } catch (error) {
    console.warn('Failed to load configurations from API:', error);
  }
  return null;
}

// ==================== 3. DEFAULT CONFIGURATIONS ====================

const defaultConfigurations = {
  "analytics": {
    "title": "Performance Analysis",
    "description": "Configure performance analysis settings",
    "fontSize": "15px",
    "pageTagField": "level4.timeRange",
    "components": [
      {
        "type": "chart",
        "title": "Website Performance",
        "data": {
          "type": "static",
          "data": {
            "labels": ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"],
            "values": [2.3, 2.1, 2.4, 2.2, 2.0, 2.5, 2.3],
            "unit": "seconds"
          }
        },
        "chart_config": {
          "type": "line",
          "layout": {
            "title": "Page Load Time Trend",
            "xaxis_title": "Day",
            "yaxis_title": "Load Time (s)"
          }
        }
      },
      {
        "type": "table",
        "title": "Performance Metrics",
        "data": {
          "type": "static",
          "data": {
            "columns": ["Metric", "Value", "Status", "Trend"],
            "rows": [
              ["Page Load Time", "2.3s", "Good", "‚Üì 0.2s"],
              ["First Contentful Paint", "1.8s", "Excellent", "‚Üì 0.3s"],
              ["Time to Interactive", "3.2s", "Average", "‚Üë 0.1s"],
              ["Bounce Rate", "42%", "Good", "‚Üì 3%"],
              ["Pages per Session", "3.2", "Excellent", "‚Üë 0.4"]
            ]
          }
        }
      },
      {
        "type": "metric",
        "title": "Overall Score",
        "data": {
          "type": "static",
          "data": {
            "value": 87,
            "change": "+2",
            "trend": "up"
          }
        }
      }
    ],
    "levels": {
      "level2": {
        "title": "Analysis Type",
        "type": "dropdown",
        "id": "analysisType",
        "label": "Select analysis type",
        "values": ["Web Performance", "User Engagement", "Conversion", "Retention"],
        "mandatory": true,
        "nextLevels": {
          "Web Performance": {
            "level3": {
              "title": "Web Metrics",
              "type": "checkbox",
              "id": "webMetrics",
              "label": "Metrics to analyze",
              "mandatory": true,
              "options": [
                {"label": "Loading time", "value": "loadTime"},
                {"label": "Bounce rate", "value": "bounceRate"},
                {"label": "Pages per session", "value": "pagesPerSession"},
                {"label": "Session duration", "value": "sessionDuration"},
                {"label": "Conversion rate", "value": "conversionRate"}
              ],
              "nextLevels": {
                "selected": {
                  "level4": {
                    "title": "Analysis Period",
                    "controls": [
                      {
                        "type": "dropdown",
                        "id": "timeRange",
                        "label": "Time period",
                        "values": ["Last 7 days", "Last 30 days", "Last quarter", "Last year", "Custom range"],
                        "mandatory": true
                      },
                      {
                        "type": "input",
                        "id": "customDate",
                        "label": "Custom date (YYYY-MM-DD)",
                        "inputType": "date",
                        "placeholder": "2024-01-15"
                      },
                      {
                        "type": "dropdown",
                        "id": "granularity",
                        "label": "Data granularity",
                        "values": ["Hourly", "Daily", "Weekly", "Monthly"],
                        "mandatory": false
                      }
                    ],
                    "isLastLevel": true
                  }
                }
              }
            }
          }
        }
      }
    }
  },
  
  "userData": {
    "title": "User Analytics",
    "description": "Configure user data analysis settings",
    "fontSize": "15px",
    "pageTagField": "level4.userThreshold",
    "components": [
      {
        "type": "chart",
        "title": "User Growth",
        "data": {
          "type": "static",
          "data": {
            "labels": ["Jan", "Feb", "Mar", "Apr", "May", "Jun"],
            "values": [1200, 1450, 1800, 2100, 2500, 2900],
            "unit": "users"
          }
        },
        "chart_config": {
          "type": "bar",
          "layout": {
            "title": "Monthly User Growth",
            "xaxis_title": "Month",
            "yaxis_title": "Number of Users"
          }
        }
      },
      {
        "type": "table",
        "title": "User Segments",
        "data": {
          "type": "static",
          "data": {
            "columns": ["Segment", "Users", "Growth", "Activity"],
            "rows": [
              ["New Users", "1,240", "+12%", "High"],
              ["Active Users", "890", "+8%", "Very High"],
              ["Power Users", "310", "+5%", "Extreme"],
              ["Churned Users", "180", "-3%", "Low"]
            ]
          }
        }
      }
    ],
    "levels": {
      "level2": {
        "title": "User Segment",
        "type": "dropdown",
        "id": "userSegment",
        "label": "Select user segment",
        "values": ["New users", "Active users", "Premium users", "Churned users"],
        "mandatory": true,
        "nextLevels": {
          "Active users": {
            "level3": {
              "title": "Activity Metrics",
              "type": "checkbox",
              "id": "activityMetrics",
              "label": "Metrics to track",
              "mandatory": true,
              "options": [
                {"label": "Sessions per user", "value": "sessionsPerUser"},
                {"label": "Usage frequency", "value": "usageFrequency"},
                {"label": "Features used", "value": "featuresUsed"},
                {"label": "Time spent", "value": "timeSpent"},
                {"label": "Engagement score", "value": "engagementScore"}
              ],
              "nextLevels": {
                "selected": {
                  "level4": {
                    "title": "Additional Settings",
                    "controls": [
                      {
                        "type": "input",
                        "id": "userThreshold",
                        "label": "Minimum users threshold",
                        "inputType": "number",
                        "placeholder": "Enter minimum number",
                        "mandatory": true
                      },
                      {
                        "type": "input",
                        "id": "reportName",
                        "label": "Report name",
                        "inputType": "text",
                        "placeholder": "Enter report name"
                      },
                      {
                        "type": "dropdown",
                        "id": "dataSource",
                        "label": "Data source",
                        "values": ["Analytics API", "Database", "CSV Import", "Manual Entry"],
                        "mandatory": false
                      }
                    ],
                    "isLastLevel": true
                  }
                }
              }
            }
          }
        }
      }
    }
  },
  
  "systemMetrics": {
    "title": "System Monitoring",
    "description": "Configure system monitoring settings",
    "fontSize": "14px",
    "pageTagField": "level4.cpuThreshold",
    "components": [
      {
        "type": "chart",
        "title": "CPU Usage",
        "data": {
          "type": "static",
          "data": {
            "labels": ["00:00", "04:00", "08:00", "12:00", "16:00", "20:00"],
            "values": [32, 28, 45, 62, 51, 38],
            "unit": "%"
          }
        },
        "chart_config": {
          "type": "line",
          "layout": {
            "title": "CPU Usage Over 24 Hours",
            "xaxis_title": "Time",
            "yaxis_title": "CPU Usage (%)"
          }
        }
      },
      {
        "type": "table",
        "title": "Server Status",
        "data": {
          "type": "static",
          "data": {
            "columns": ["Server", "Status", "CPU", "Memory", "Disk"],
            "rows": [
              ["Server-01", "‚úÖ Online", "45%", "68%", "42%"],
              ["Server-02", "‚úÖ Online", "32%", "54%", "38%"],
              ["Server-03", "‚ö†Ô∏è Warning", "78%", "82%", "65%"],
              ["Server-04", "‚úÖ Online", "28%", "61%", "45%"],
              ["Server-05", "‚ùå Offline", "0%", "0%", "0%"]
            ]
          }
        }
      },
      {
        "type": "metric",
        "title": "System Health",
        "data": {
          "type": "static",
          "data": {
            "value": 92,
            "change": "-3",
            "trend": "down"
          }
        }
      }
    ],
    "levels": {
      "level2": {
        "title": "Monitoring Type",
        "type": "dropdown",
        "id": "monitoringType",
        "label": "Select monitoring type",
        "values": ["Performance", "Availability", "Security", "Network"],
        "mandatory": true,
        "nextLevels": {
          "Performance": {
            "level3": {
              "title": "Performance Indicators",
              "type": "checkbox",
              "id": "performanceIndicators",
              "label": "Indicators to monitor",
              "mandatory": true,
              "options": [
                {"label": "CPU Usage", "value": "cpuUsage"},
                {"label": "Memory usage", "value": "memoryUsage"},
                {"label": "API response time", "value": "apiResponseTime"},
                {"label": "Disk I/O", "value": "diskIO"},
                {"label": "Network latency", "value": "networkLatency"}
              ],
              "nextLevels": {
                "selected": {
                  "level4": {
                    "title": "Alert Settings",
                    "controls": [
                      {
                        "type": "input",
                        "id": "alertEmail",
                        "label": "Alert email",
                        "inputType": "email",
                        "placeholder": "admin@example.com",
                        "mandatory": true
                      },
                      {
                        "type": "input",
                        "id": "cpuThreshold",
                        "label": "CPU threshold (%)",
                        "inputType": "number",
                        "placeholder": "80",
                        "mandatory": true
                      },
                      {
                        "type": "input",
                        "id": "memoryThreshold",
                        "label": "Memory threshold (%)",
                        "inputType": "number",
                        "placeholder": "85",
                        "mandatory": false
                      }
                    ],
                    "isLastLevel": true
                  }
                }
              }
            }
          }
        }
      }
    }
  },
  
  "salesData": {
    "title": "Sales Analytics",
    "description": "Configure sales data analysis settings",
    "fontSize": "16px",
    "pageTagField": "level4.currency",
    "components": [
      {
        "type": "chart",
        "title": "Revenue Growth",
        "data": {
          "type": "static",
          "data": {
            "labels": ["Q1", "Q2", "Q3", "Q4"],
            "values": [45000, 52000, 61000, 68000],
            "unit": "$"
          }
        },
        "chart_config": {
          "type": "bar",
          "layout": {
            "title": "Quarterly Revenue",
            "xaxis_title": "Quarter",
            "yaxis_title": "Revenue ($)"
          }
        }
      },
      {
        "type": "table",
        "title": "Top Products",
        "data": {
          "type": "static",
          "data": {
            "columns": ["Product", "Sales", "Revenue", "Growth"],
            "rows": [
              ["Product A", "320 units", "$25,600", "+15%"],
              ["Product B", "280 units", "$19,600", "+12%"],
              ["Product C", "210 units", "$15,750", "+18%"],
              ["Product D", "180 units", "$12,600", "+8%"],
              ["Product E", "150 units", "$9,750", "+22%"]
            ]
          }
        }
      },
      {
        "type": "metric",
        "title": "Total Revenue",
        "data": {
          "type": "static",
          "data": {
            "value": "$333,000",
            "change": "+15%",
            "trend": "up"
          }
        }
      }
    ],
    "levels": {
      "level2": {
        "title": "Sales Analysis Type",
        "type": "dropdown",
        "id": "salesAnalysisType",
        "label": "Select analysis type",
        "values": ["Revenue", "Customers", "Products", "Regions"],
        "mandatory": true,
        "nextLevels": {
          "Revenue": {
            "level3": {
              "title": "Revenue KPIs",
              "type": "checkbox",
              "id": "revenueKPIs",
              "label": "Key performance indicators",
              "mandatory": true,
              "options": [
                {"label": "Total revenue", "value": "totalRevenue"},
                {"label": "Average order value", "value": "avgOrderValue"},
                {"label": "Revenue per customer", "value": "revenuePerCustomer"},
                {"label": "Monthly recurring revenue", "value": "mrr"},
                {"label": "Year-over-year growth", "value": "yoyGrowth"}
              ],
              "nextLevels": {
                "selected": {
                  "level4": {
                    "title": "Report Settings",
                    "controls": [
                      {
                        "type": "input",
                        "id": "currency",
                        "label": "Currency",
                        "inputType": "text",
                        "placeholder": "USD, EUR, GBP, etc.",
                        "mandatory": true
                      },
                      {
                        "type": "input",
                        "id": "region",
                        "label": "Region filter",
                        "inputType": "text",
                        "placeholder": "North America, Europe, Asia, etc."
                      },
                      {
                        "type": "dropdown",
                        "id": "timeFrame",
                        "label": "Time frame",
                        "values": ["Daily", "Weekly", "Monthly", "Quarterly", "Yearly"],
                        "mandatory": false
                      }
                    ],
                    "isLastLevel": true
                  }
                }
              }
            }
          }
        }
      }
    }
  }
};

// ==================== 4. INITIALIZATION ====================

async function initializeApp() {
  showLoading(true);
  
  // Test API connection
  await testApiConnection();
  
  // Load configurations
  if (isApiConnected) {
    const apiConfigs = await loadConfigurationsFromApi();
    if (apiConfigs) {
      availableConfigs = apiConfigs;
      showToast('Configurations loaded from server', 'success');
    } else {
      availableConfigs = defaultConfigurations;
      showToast('Using default configurations', 'info');
    }
  } else {
    availableConfigs = defaultConfigurations;
  }
  
  // Load saved pages
  loadFromLocalStorage();
  
  // Show initial interface
  showConfigurationInterface();
  
  showLoading(false);
}

// ==================== 5. LOCAL STORAGE MANAGEMENT ====================

function saveToLocalStorage() {
  try {
    localStorage.setItem('savedConfigurations', JSON.stringify(savedConfigurations));
    localStorage.setItem('appVersion', APP_VERSION);
  } catch (error) {
    console.error('Error saving to localStorage:', error);
  }
}

function loadFromLocalStorage() {
  try {
    const saved = localStorage.getItem('savedConfigurations');
    if (saved) {
      savedConfigurations = JSON.parse(saved);
      rebuildPagesList();
    }
    
    // Clear old data if version changed
    const savedVersion = localStorage.getItem('appVersion');
    if (savedVersion !== APP_VERSION) {
      localStorage.clear();
      showToast('App updated - localStorage cleared', 'info');
    }
  } catch (error) {
    console.error('Error loading from localStorage:', error);
    savedConfigurations = [];
  }
}

function rebuildPagesList() {
  const pagesList = document.getElementById('pagesList');
  pagesList.innerHTML = '';
  
  // Sort by date (newest first)
  savedConfigurations.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
  
  // Keep only last 20 pages
  if (savedConfigurations.length > 20) {
    savedConfigurations = savedConfigurations.slice(0, 20);
    saveToLocalStorage();
  }
  
  savedConfigurations.forEach(configData => {
    const pageItem = createPageElement(configData);
    pagesList.appendChild(pageItem);
  });
}

function createPageElement(configData) {
  const pageItem = document.createElement("div");
  pageItem.className = "page-item";
  pageItem.dataset.configId = configData.id;
  
  const date = new Date(configData.timestamp);
  const dateStr = `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth()+1).toString().padStart(2, '0')}/${date.getFullYear()} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
  
  const tagValue = extractTagValue(configData);
  
  pageItem.innerHTML = `
    <div class="delete-page" onclick="deletePage('${configData.id}', event)">√ó</div>
    <div class="page-title">
      ${configData.pageName || configData.title}
      ${tagValue ? `<span class="page-tag">${tagValue}</span>` : ''}
    </div>
    <div class="page-date">${dateStr}</div>
  `;
  
  pageItem.addEventListener("click", function(e) {
    if (e.target.classList.contains('delete-page')) return;
    
    document.querySelectorAll('.page-item, .nav-item').forEach(item => {
      item.classList.remove('active');
    });
    
    this.classList.add('active');
    
    const page = savedConfigurations.find(p => p.id === this.dataset.configId);
    if (page) {
      showPageVisualization(page);
    }
  });
  
  return pageItem;
}

function extractTagValue(configData) {
  const config = availableConfigs[configData.type];
  if (!config || !config.pageTagField) return null;
  
  const [levelKey, fieldName] = config.pageTagField.split('.');
  if (!levelKey || !fieldName) return null;
  
  const levelSelections = configData.selections[levelKey];
  if (!levelSelections) return null;
  
  const tagValue = levelSelections[fieldName];
  if (Array.isArray(tagValue)) {
    return tagValue.slice(0, 2).join(', ');
  }
  
  return tagValue;
}

// ==================== 6. CONFIGURATION INTERFACE ====================

function showConfigurationInterface() {
  const contentArea = document.getElementById('contentArea');
  
  contentArea.innerHTML = `
    <div id="initialContent">
      <h1 class="panel-title">Configuration Dashboard</h1>
      <p style="color: #666; margin-bottom: 25px; font-size: 16px; line-height: 1.6;">
        Welcome to the JSON-Driven Dashboard Generator. Configure settings to generate dynamic pages with charts, tables, and metrics.
        <span style="color: #ff4444; font-weight: 600;">*</span> indicates mandatory fields.
      </p>

      <div class="level-container" id="level1-container">
        <div class="level-title">Level 1: Configuration Type</div>
        <div class="control-group">
          <label class="required">Select configuration type</label>
          <select id="level1">
            <option value="">‚Äî Please select ‚Äî</option>
            ${Object.keys(availableConfigs).map(key => 
              `<option value="${key}">${availableConfigs[key].title}</option>`
            ).join('')}
          </select>
          <div class="error-message" id="level1-error">Please select a configuration type</div>
        </div>
      </div>

      <div id="levelsContainer"></div>
      
      <div id="connectionStatus" style="margin-top: 30px; padding: 15px; background: #f0f9f5; border-radius: 8px; display: flex; align-items: center; gap: 10px;">
        <div id="statusIndicator" style="width: 12px; height: 12px; border-radius: 50%; background: #00a678; animation: pulse 2s infinite;"></div>
        <span style="color: #007348; font-weight: 500;">${isApiConnected ? 'Connected to API server' : 'Offline mode - using local configurations'}</span>
      </div>
    </div>
  `;
  
  document.getElementById('configNav').classList.add('active');
  
  // Event listener for level1 selection
  document.getElementById("level1").addEventListener("change", function(e) {
    const configName = e.target.value;
    const container = document.getElementById("levelsContainer");
    const errorMsg = document.getElementById("level1-error");
    
    if (configName) {
      this.classList.remove('error');
      errorMsg.classList.remove('show');
    } else {
      this.classList.add('error');
      errorMsg.classList.add('show');
    }
    
    container.innerHTML = "";
    currentLevel1 = configName;
    currentSelections = {};
    currentLevels = {};
    selectedPages = {};

    if (!configName) return;

    const config = availableConfigs[configName];
    if (!config) return;

    document.body.style.fontSize = config.fontSize || "14px";
    renderLevel("level2", config.levels.level2, container);
  });
}

// ==================== 7. RENDERING FUNCTIONS ====================

function renderLevel(levelKey, levelConfig, container) {
  const levelContainer = document.createElement("div");
  levelContainer.id = `${levelKey}-container`;
  levelContainer.className = "level-container";
  
  const titleEl = document.createElement("div");
  titleEl.className = "level-title";
  titleEl.innerHTML = `${levelKey.toUpperCase().replace('LEVEL', 'Level ')}: ${levelConfig.title}`;
  levelContainer.appendChild(titleEl);

  currentLevels[levelKey] = levelConfig;

  if (levelConfig.controls) {
    levelConfig.controls.forEach(control => {
      renderControl(control, levelKey, levelContainer, levelConfig);
    });
  } else {
    renderControl(levelConfig, levelKey, levelContainer, levelConfig);
  }

  container.appendChild(levelContainer);
  
  if (levelConfig.isLastLevel) {
    addPageSelectionInterface(container);
    addActionButtons(levelKey, container);
  }
}

function renderControl(controlConfig, levelKey, container, levelConfig) {
  const controlGroup = document.createElement("div");
  controlGroup.className = "control-group";
  
  const label = document.createElement("label");
  label.textContent = controlConfig.label;
  label.htmlFor = controlConfig.id;
  
  if (controlConfig.mandatory) {
    label.classList.add("required");
  }
  
  controlGroup.appendChild(label);
  
  const errorMsg = document.createElement("div");
  errorMsg.className = "error-message";
  errorMsg.id = `${controlConfig.id}-error`;
  errorMsg.textContent = `Please fill in "${controlConfig.label}"`;
  
  if (controlConfig.type === "dropdown") {
    const select = document.createElement("select");
    select.id = controlConfig.id;
    
    const defaultOption = document.createElement("option");
    defaultOption.value = "";
    defaultOption.textContent = `-- Select --`;
    select.appendChild(defaultOption);
    
    controlConfig.values.forEach(value => {
      const option = document.createElement("option");
      option.value = value;
      option.textContent = value;
      select.appendChild(option);
    });
    
    select.addEventListener("change", function() {
      const levelNum = parseInt(levelKey.replace("level", ""));
      
      if (this.value) {
        this.classList.remove('error');
        errorMsg.classList.remove('show');
      } else if (controlConfig.mandatory) {
        this.classList.add('error');
        errorMsg.classList.add('show');
      }
      
      clearLevelsFrom(levelNum + 1);
      
      currentSelections[levelKey] = {
        ...currentSelections[levelKey],
        [controlConfig.id]: this.value
      };
      
      if (levelConfig.nextLevels && levelConfig.nextLevels[this.value]) {
        const nextLevelKey = `level${levelNum + 1}`;
        const nextLevelConfig = levelConfig.nextLevels[this.value][nextLevelKey];
        if (nextLevelConfig) {
          renderLevel(nextLevelKey, nextLevelConfig, document.getElementById("levelsContainer"));
        }
      }
    });
    
    controlGroup.appendChild(select);
    controlGroup.appendChild(errorMsg);
  } 
  else if (controlConfig.type === "checkbox") {
    const checkboxGroup = document.createElement("div");
    checkboxGroup.className = "checkbox-group";
    
    controlConfig.options.forEach(option => {
      const optionContainer = document.createElement("label");
      
      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.value = option.value;
      checkbox.id = `${controlConfig.id}_${option.value}`;
      
      const span = document.createElement("span");
      span.textContent = option.label;
      span.style.marginLeft = "8px";
      
      optionContainer.appendChild(checkbox);
      optionContainer.appendChild(span);
      checkboxGroup.appendChild(optionContainer);
      
      checkbox.addEventListener("change", function() {
        const levelNum = parseInt(levelKey.replace("level", ""));
        
        clearLevelsFrom(levelNum + 1);
        
        const checkboxes = checkboxGroup.querySelectorAll('input[type="checkbox"]');
        const selectedValues = Array.from(checkboxes)
          .filter(cb => cb.checked)
          .map(cb => cb.value);
        
        currentSelections[levelKey] = {
          ...currentSelections[levelKey],
          [controlConfig.id]: selectedValues
        };
        
        if (controlConfig.mandatory) {
          if (selectedValues.length === 0) {
            checkboxGroup.classList.add('error');
            errorMsg.classList.add('show');
          } else {
            checkboxGroup.classList.remove('error');
            errorMsg.classList.remove('show');
          }
        }
        
        if (levelConfig.nextLevels && levelConfig.nextLevels.selected && selectedValues.length > 0) {
          const nextLevelKey = `level${levelNum + 1}`;
          const nextLevelConfig = levelConfig.nextLevels.selected[nextLevelKey];
          if (nextLevelConfig) {
            renderLevel(nextLevelKey, nextLevelConfig, document.getElementById("levelsContainer"));
          }
        }
      });
    });
    
    controlGroup.appendChild(checkboxGroup);
    controlGroup.appendChild(errorMsg);
  }
  else if (controlConfig.type === "input") {
    const input = document.createElement("input");
    input.type = controlConfig.inputType || "text";
    input.id = controlConfig.id;
    input.placeholder = controlConfig.placeholder || "";
    
    input.addEventListener("input", function() {
      currentSelections[levelKey] = {
        ...currentSelections[levelKey],
        [controlConfig.id]: this.value
      };
      
      if (controlConfig.mandatory) {
        if (!this.value.trim()) {
          this.classList.add('error');
          errorMsg.classList.add('show');
        } else {
          this.classList.remove('error');
          errorMsg.classList.remove('show');
        }
      }
    });
    
    input.addEventListener("blur", function() {
      if (controlConfig.mandatory && !this.value.trim()) {
        this.classList.add('error');
        errorMsg.classList.add('show');
      }
    });
    
    controlGroup.appendChild(input);
    controlGroup.appendChild(errorMsg);
  }
  
  container.appendChild(controlGroup);
}

function clearLevelsFrom(startLevel) {
  for (let i = startLevel; i <= 4; i++) {
    const levelContainer = document.getElementById(`level${i}-container`);
    if (levelContainer) {
      levelContainer.remove();
    }
    delete currentSelections[`level${i}`];
    delete currentLevels[`level${i}`];
  }
}

// ==================== 8. VALIDATION ====================

function validateMandatoryFields() {
  let isValid = true;
  const missingFields = [];
  
  const level1Select = document.getElementById("level1");
  if (!level1Select || !level1Select.value) {
    isValid = false;
    missingFields.push("Configuration Type");
    if (level1Select) {
      level1Select.classList.add('error');
      document.getElementById("level1-error").classList.add('show');
    }
  }
  
  Object.keys(currentLevels).forEach(levelKey => {
    const levelConfig = currentLevels[levelKey];
    
    if (levelConfig.controls) {
      levelConfig.controls.forEach(controlConfig => {
        if (controlConfig.mandatory) {
          const control = document.getElementById(controlConfig.id);
          if (control) {
            if (controlConfig.type === "dropdown") {
              if (!control.value) {
                isValid = false;
                missingFields.push(controlConfig.label);
                control.classList.add('error');
                document.getElementById(`${controlConfig.id}-error`).classList.add('show');
              }
            } else if (controlConfig.type === "checkbox") {
              const checkboxes = document.querySelectorAll(`input[id^="${controlConfig.id}_"]`);
              const isChecked = Array.from(checkboxes).some(cb => cb.checked);
              if (!isChecked) {
                isValid = false;
                missingFields.push(controlConfig.label);
                const checkboxGroup = control.closest('.checkbox-group');
                if (checkboxGroup) {
                  checkboxGroup.classList.add('error');
                }
                document.getElementById(`${controlConfig.id}-error`).classList.add('show');
              }
            } else if (controlConfig.type === "input") {
              if (!control.value.trim()) {
                isValid = false;
                missingFields.push(controlConfig.label);
                control.classList.add('error');
                document.getElementById(`${controlConfig.id}-error`).classList.add('show');
              }
            }
          }
        }
      });
    } else {
      if (levelConfig.mandatory) {
        const control = document.getElementById(levelConfig.id);
        if (control) {
          if (levelConfig.type === "dropdown") {
            if (!control.value) {
              isValid = false;
              missingFields.push(levelConfig.label);
              control.classList.add('error');
              document.getElementById(`${levelConfig.id}-error`).classList.add('show');
            }
          } else if (levelConfig.type === "checkbox") {
            const checkboxes = document.querySelectorAll(`input[id^="${levelConfig.id}_"]`);
            const isChecked = Array.from(checkboxes).some(cb => cb.checked);
            if (!isChecked) {
              isValid = false;
              missingFields.push(levelConfig.label);
              const checkboxGroup = control.closest('.checkbox-group');
              if (checkboxGroup) {
                checkboxGroup.classList.add('error');
              }
              document.getElementById(`${levelConfig.id}-error`).classList.add('show');
            }
          }
        }
      }
    }
  });
  
  return { isValid, missingFields };
}

function showMandatoryPopup(missingFields) {
  const popup = document.getElementById('mandatoryPopup');
  const list = document.getElementById('missingFieldsList');
  
  list.innerHTML = '';
  missingFields.forEach(field => {
    const li = document.createElement('li');
    li.textContent = field;
    list.appendChild(li);
  });
  
  popup.style.display = 'flex';
}

function closeMandatoryPopup() {
  document.getElementById('mandatoryPopup').style.display = 'none';
}

// ==================== 9. PAGE SELECTION ====================

function addPageSelectionInterface(container) {
  if (!currentLevel1) return;
  
  const config = availableConfigs[currentLevel1];
  if (!config.components || config.components.length === 0) return;
  
  const pageSelectionContainer = document.createElement("div");
  pageSelectionContainer.className = "page-selection-container";
  pageSelectionContainer.id = "pageSelectionContainer";
  
  const titleEl = document.createElement("div");
  titleEl.className = "page-selection-title";
  titleEl.textContent = "Components to Generate";
  pageSelectionContainer.appendChild(titleEl);
  
  const pageOptions = document.createElement("div");
  pageOptions.className = "page-options";
  
  config.components.forEach((component, index) => {
    const componentId = `comp_${index}`;
    selectedPages[componentId] = true;
    
    const pageOption = document.createElement("div");
    pageOption.className = "page-option selected";
    pageOption.dataset.pageId = componentId;
    
    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.id = `page_${componentId}`;
    checkbox.checked = true;
    
    const labelContainer = document.createElement("div");
    labelContainer.style.flex = "1";
    
    const label = document.createElement("div");
    label.className = "page-option-label";
    label.textContent = component.title;
    
    const description = document.createElement("div");
    description.className = "page-option-description";
    description.textContent = getComponentDescription(component.type);
    
    labelContainer.appendChild(label);
    labelContainer.appendChild(description);
    
    pageOption.appendChild(checkbox);
    pageOption.appendChild(labelContainer);
    
    pageOption.addEventListener("click", function(e) {
      if (e.target.type === "checkbox") return;
      checkbox.checked = !checkbox.checked;
      updatePageSelection(componentId, checkbox.checked);
    });
    
    checkbox.addEventListener("change", function() {
      updatePageSelection(componentId, this.checked);
    });
    
    pageOptions.appendChild(pageOption);
  });
  
  pageSelectionContainer.appendChild(pageOptions);
  
  const selectionControls = document.createElement("div");
  selectionControls.className = "selection-controls";
  
  const selectAllBtn = document.createElement("button");
  selectAllBtn.textContent = "Select All";
  selectAllBtn.onclick = function() {
    config.components.forEach((component, index) => {
      const componentId = `comp_${index}`;
      selectedPages[componentId] = true;
      const checkbox = document.getElementById(`page_${componentId}`);
      if (checkbox) checkbox.checked = true;
      const option = document.querySelector(`[data-page-id="${componentId}"]`);
      if (option) option.classList.add('selected');
    });
  };
  
  const selectNoneBtn = document.createElement("button");
  selectNoneBtn.textContent = "Select None";
  selectNoneBtn.onclick = function() {
    config.components.forEach((component, index) => {
      const componentId = `comp_${index}`;
      selectedPages[componentId] = false;
      const checkbox = document.getElementById(`page_${componentId}`);
      if (checkbox) checkbox.checked = false;
      const option = document.querySelector(`[data-page-id="${componentId}"]`);
      if (option) option.classList.remove('selected');
    });
  };
  
  selectionControls.appendChild(selectAllBtn);
  selectionControls.appendChild(selectNoneBtn);
  pageSelectionContainer.appendChild(selectionControls);
  
  container.appendChild(pageSelectionContainer);
}

function getComponentDescription(type) {
  switch(type) {
    case 'chart': return 'Interactive chart visualization';
    case 'table': return 'Data table with sorting';
    case 'metric': return 'Key performance indicator';
    default: return 'Custom component';
  }
}

function updatePageSelection(pageId, isSelected) {
  selectedPages[pageId] = isSelected;
  const pageOption = document.querySelector(`[data-page-id="${pageId}"]`);
  if (pageOption) {
    if (isSelected) {
      pageOption.classList.add('selected');
    } else {
      pageOption.classList.remove('selected');
    }
  }
}

// ==================== 10. ACTION BUTTONS ====================

function addActionButtons(levelKey, container) {
  const buttonContainer = document.createElement("div");
  buttonContainer.style.marginTop = "20px";
  buttonContainer.style.display = "flex";
  buttonContainer.style.flexWrap = "wrap";
  buttonContainer.style.gap = "15px";
  
  const generateBtn = document.createElement("button");
  generateBtn.className = "submit-btn";
  generateBtn.textContent = "Generate Dashboard";
  
  const resetBtn = document.createElement("button");
  resetBtn.className = "reset-btn";
  resetBtn.textContent = "Reset Configuration";
  
  generateBtn.addEventListener("click", async function() {
    const validation = validateMandatoryFields();
    
    if (!validation.isValid) {
      showMandatoryPopup(validation.missingFields);
      return;
    }
    
    await generatePage();
  });
  
  resetBtn.addEventListener("click", function() {
    if (confirm("Are you sure you want to reset all configuration?")) {
      showConfigurationInterface();
    }
  });
  
  buttonContainer.appendChild(generateBtn);
  buttonContainer.appendChild(resetBtn);
  container.appendChild(buttonContainer);
}

// ==================== 11. PAGE GENERATION ====================

async function generatePage() {
  const allSelections = {...currentSelections};
  const configName = currentLevel1;
  const config = availableConfigs[configName];
  
  if (!config.components || config.components.length === 0) {
    showToast("No components available for this configuration", "error");
    return;
  }
  
  const selectedComponents = config.components.filter((component, index) => 
    selectedPages[`comp_${index}`]
  );
  
  if (selectedComponents.length === 0) {
    showToast("Please select at least one component", "error");
    return;
  }
  
  showToast("Generating dashboard...", "info");
  
  try {
    let pageData;
    
    if (isApiConnected) {
      const pageConfig = {
        config: {
          type: configName,
          title: config.title,
          description: config.description,
          components: selectedComponents
        },
        selections: allSelections,
        save: true
      };
      
      const response = await fetch(`${API_BASE_URL}/generate-page`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(pageConfig)
      });
      
      if (!response.ok) {
        throw new Error(`API error: ${response.status}`);
      }
      
      pageData = await response.json();
    } else {
      // Local generation
      pageData = generateLocalPage(configName, allSelections, selectedComponents);
    }
    
    const configData = {
      id: pageData.page_id || `local-${Date.now()}`,
      type: configName,
      title: config.title,
      pageName: pageData.title || config.title,
      selections: allSelections,
      timestamp: new Date().toISOString(),
      pageConfig: pageData
    };
    
    savedConfigurations.push(configData);
    addPageToList(configData);
    saveToLocalStorage();
    
    showPageVisualization(configData);
    showToast("Dashboard generated successfully!", "success");
    
  } catch (error) {
    console.error('Error generating page:', error);
    showToast(`Error: ${error.message}`, "error");
    
    // Fallback to local generation
    generateLocalFallback(configName, allSelections, selectedComponents);
  }
}

function generateLocalPage(configName, selections, selectedComponents) {
  const config = availableConfigs[configName];
  
  const pageData = {
    page_id: `local-${Date.now()}`,
    title: config.title,
    timestamp: new Date().toISOString(),
    metadata: {
      generatedAt: new Date().toISOString(),
      configType: configName,
      selections: selections
    },
    components: []
  };
  
  selectedComponents.forEach((component, index) => {
    const componentData = {
      id: `comp-${index}`,
      type: component.type,
      title: component.title,
      config: component
    };
    
    if (component.type === 'chart') {
      componentData.chart = generateSampleChartData(component);
    } else if (component.type === 'table') {
      componentData.table = generateSampleTableData(component);
    } else if (component.type === 'metric') {
      componentData.metric = generateSampleMetricData(component);
    }
    
    pageData.components.push(componentData);
  });
  
  return pageData;
}

function generateLocalFallback(configName, selections, selectedComponents) {
  const configData = {
    id: `fallback-${Date.now()}`,
    type: configName,
    title: availableConfigs[configName].title,
    pageName: availableConfigs[configName].title,
    selections: selections,
    timestamp: new Date().toISOString(),
    pageConfig: generateLocalPage(configName, selections, selectedComponents)
  };
  
  savedConfigurations.push(configData);
  addPageToList(configData);
  saveToLocalStorage();
  showPageVisualization(configData);
}

function generateSampleChartData(component) {
  const chartData = {
    data: [{
      x: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
      y: [2.3, 2.1, 2.4, 2.2, 2.0, 2.5, 2.3],
      type: 'scatter',
      mode: 'lines+markers',
      line: { color: '#00a678', width: 3 },
      marker: { size: 8, color: '#007348' }
    }],
    layout: {
      title: component.title,
      plot_bgcolor: 'white',
      paper_bgcolor: 'white',
      font: { family: 'Arial', size: 12 },
      xaxis: { title: 'Day' },
      yaxis: { title: 'Value' }
    }
  };
  
  return JSON.stringify(chartData);
}

function generateSampleTableData(component) {
  return {
    columns: ['Metric', 'Value', 'Status'],
    rows: [
      ['Sample Metric 1', '123', 'Good'],
      ['Sample Metric 2', '456', 'Excellent'],
      ['Sample Metric 3', '789', 'Average'],
      ['Sample Metric 4', '321', 'Poor'],
      ['Sample Metric 5', '654', 'Good']
    ],
    total: 5
  };
}

function generateSampleMetricData(component) {
  return {
    value: Math.floor(Math.random() * 100),
    change: Math.random() > 0.5 ? `+${Math.floor(Math.random() * 10)}` : `-${Math.floor(Math.random() * 10)}`,
    trend: Math.random() > 0.5 ? 'up' : 'down'
  };
}

function addPageToList(configData) {
  const pagesList = document.getElementById("pagesList");
  const pageItem = createPageElement(configData);
  
  if (pagesList.firstChild) {
    pagesList.insertBefore(pageItem, pagesList.firstChild);
  } else {
    pagesList.appendChild(pageItem);
  }
}

// ==================== 12. PAGE VISUALIZATION ====================

function showPageVisualization(configData) {
  const contentArea = document.getElementById('contentArea');
  const pageData = configData.pageConfig;
  
  const tagValue = extractTagValue(configData);
  
  let visualizationsHTML = `
    <h1 class="panel-title">
      ${configData.pageName || pageData.title}
      ${tagValue ? `<span style="font-size: 18px; color: #00a678; margin-left: 10px;">(${tagValue})</span>` : ''}
    </h1>
    ${displayConfigurationSummary(configData)}
  `;
  
  if (pageData.components && pageData.components.length > 0) {
    pageData.components.forEach((component, index) => {
      if (component.type === 'chart' && component.chart) {
        const chartId = `chart-${Date.now()}-${index}`;
        visualizationsHTML += `
          <div class="chart-container">
            <div class="chart-title">${component.title}</div>
            <div id="${chartId}" class="chart-content"></div>
          </div>
        `;
        
        setTimeout(() => {
          try {
            if (typeof component.chart === 'string') {
              const chartData = JSON.parse(component.chart);
              Plotly.newPlot(chartId, chartData.data, chartData.layout);
            } else if (typeof component.chart === 'object') {
              Plotly.newPlot(chartId, component.chart.data, component.chart.layout);
            }
          } catch (e) {
            document.getElementById(chartId).innerHTML = `
              <div style="text-align: center; padding: 40px;">
                <div style="font-size: 48px; color: #007348;">üìà</div>
                <div style="margin-top: 20px;">
                  <strong>${component.title}</strong><br>
                  <small>Sample data visualization</small>
                </div>
                <div style="margin-top: 20px; background: linear-gradient(90deg, #00a678 70%, #8dc9ab 30%); 
                           height: 20px; width: 100%; border-radius: 10px;"></div>
              </div>
            `;
          }
        }, 100);
        
      } else if (component.type === 'table' && component.table) {
        let tableRows = "";
        if (component.table.rows && Array.isArray(component.table.rows)) {
          component.table.rows.forEach(row => {
            tableRows += `<tr>`;
            row.forEach(cell => {
              tableRows += `<td>${cell}</td>`;
            });
            tableRows += `</tr>`;
          });
        }
        
        visualizationsHTML += `
          <div class="table-container">
            <div class="table-title">${component.title}</div>
            <table class="data-table">
              <thead>
                <tr>
                  ${(component.table.columns || []).map(header => `<th>${header}</th>`).join('')}
                </tr>
              </thead>
              <tbody>
                ${tableRows}
              </tbody>
            </table>
          </div>
        `;
        
      } else if (component.type === 'metric' && component.metric) {
        visualizationsHTML += `
          <div class="metric-card">
            <div class="metric-item">
              <div class="metric-value">${component.metric.value || 0}</div>
              <div class="metric-label">${component.title}</div>
              ${component.metric.change ? `
                <div style="font-size: 12px; color: ${component.metric.trend === 'up' ? '#00a678' : '#ff4444'}">
                  ${component.metric.trend === 'up' ? '‚Üó' : '‚Üò'} ${component.metric.change}
                </div>
              ` : ''}
            </div>
          </div>
        `;
      }
    });
  } else {
    visualizationsHTML += `
      <div class="comment-box-container">
        <div class="comment-title">No Components</div>
        <div class="comment-content">
          This page doesn't have any components to display.
        </div>
      </div>
    `;
  }
  
  contentArea.innerHTML = visualizationsHTML;
}

// ==================== 13. UTILITY FUNCTIONS ====================

function displayConfigurationSummary(configData) {
  const config = availableConfigs[configData.type];
  if (!config) return '';
  
  let summaryHTML = `
    <div class="config-summary">
      <div class="config-summary-title">
        Configuration Summary
        <button class="reuse-btn" onclick="reuseConfiguration('${configData.id}')">
          Reuse Config
        </button>
      </div>
      <div class="summary-content">
  `;
  
  summaryHTML += `
    <div class="summary-tag">
      <span class="summary-label">Type:</span>
      ${config.title}
    </div>
  `;
  
  Object.keys(configData.selections).forEach(levelKey => {
    const levelSelections = configData.selections[levelKey];
    Object.keys(levelSelections).forEach(controlId => {
      const value = levelSelections[controlId];
      if (value && (Array.isArray(value) ? value.length > 0 : value !== "")) {
        let displayValue = Array.isArray(value) ? value.join(", ") : value;
        if (displayValue.length > 20) {
          displayValue = displayValue.substring(0, 20) + '...';
        }
        summaryHTML += `
          <div class="summary-tag">
            <span class="summary-label">${controlId}:</span>
            ${displayValue}
          </div>
        `;
      }
    });
  });
  
  summaryHTML += `
      </div>
    </div>`;
  
  return summaryHTML;
}

function reuseConfiguration(configId) {
  const configData = savedConfigurations.find(p => p.id === configId);
  if (!configData) {
    showToast("Configuration not found", "error");
    return;
  }
  
  document.getElementById('configNav').click();
  
  setTimeout(() => {
    const level1Select = document.getElementById("level1");
    if (level1Select) {
      level1Select.value = configData.type;
      
      const event = new Event('change');
      level1Select.dispatchEvent(event);
      
      setTimeout(() => {
        recursivelyFillLevels(configData.selections, 2);
      }, 300);
    }
  }, 100);
  
  showToast("Configuration loaded", "success");
}

function recursivelyFillLevels(selections, levelNum) {
  const levelKey = `level${levelNum}`;
  const levelSelections = selections[levelKey];
  
  if (!levelSelections) return;
  
  const checkLevelExists = setInterval(() => {
    const levelContainer = document.getElementById(`${levelKey}-container`);
    if (levelContainer) {
      clearInterval(checkLevelExists);
      
      Object.keys(levelSelections).forEach(controlId => {
        const value = levelSelections[controlId];
        const control = document.getElementById(controlId);
        
        if (control) {
          if (control.type === 'select-one') {
            control.value = value;
            
            setTimeout(() => {
              const changeEvent = new Event('change');
              control.dispatchEvent(changeEvent);
              
              setTimeout(() => {
                recursivelyFillLevels(selections, levelNum + 1);
              }, 200);
            }, 100);
          } 
          else if (control.type === 'checkbox') {
            if (Array.isArray(value)) {
              value.forEach(val => {
                const checkbox = document.getElementById(`${controlId}_${val}`);
                if (checkbox) {
                  checkbox.checked = true;
                  checkbox.dispatchEvent(new Event('change', { bubbles: true }));
                }
              });
              
              if (value.length > 0) {
                setTimeout(() => {
                  const firstCheckbox = document.querySelector(`input[id^="${controlId}_"]`);
                  if (firstCheckbox) {
                    const changeEvent = new Event('change', { bubbles: true });
                    firstCheckbox.dispatchEvent(changeEvent);
                    
                    setTimeout(() => {
                      recursivelyFillLevels(selections, levelNum + 1);
                    }, 200);
                  }
                }, 100);
              }
            }
          }
          else if (control.type === 'text' || control.type === 'number' || 
                   control.type === 'email' || control.type === 'date') {
            control.value = value;
            control.dispatchEvent(new Event('input'));
            
            setTimeout(() => {
              recursivelyFillLevels(selections, levelNum + 1);
            }, 100);
          }
        } else {
          setTimeout(() => {
            recursivelyFillLevels(selections, levelNum);
          }, 100);
        }
      });
    }
  }, 100);
}

function deletePage(configId, event) {
  if (event) event.stopPropagation();
  
  if (!confirm("Are you sure you want to delete this page?\nThis action cannot be undone.")) {
    return;
  }
  
  savedConfigurations = savedConfigurations.filter(p => p.id !== configId);
  saveToLocalStorage();
  
  const pageElement = document.querySelector(`[data-config-id="${configId}"]`);
  if (pageElement) {
    pageElement.style.animation = 'slideIn 0.3s ease-out reverse';
    setTimeout(() => {
      pageElement.remove();
    }, 300);
  }
  
  const activePage = document.querySelector('.page-item.active');
  if (!activePage) {
    document.getElementById('configNav').click();
  }
  
  showToast("Page deleted", "success");
}

// ==================== 14. INITIALIZATION ====================

document.addEventListener('DOMContentLoaded', function() {
  initializeApp();
  
  document.getElementById('configNav').addEventListener('click', function() {
    document.querySelectorAll('.page-item').forEach(item => {
      item.classList.remove('active');
    });
    
    this.classList.add('active');
    showConfigurationInterface();
  });
});
</script>
</body>
</html>