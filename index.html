<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>JSON-Driven Dashboard Generator</title>

<!-- Plotly pour les graphiques -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

<style>
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #f5f7fa 0%, #e4e7eb 100%);
    color: #2c3e50;
    min-height: 100vh;
    line-height: 1.6;
  }

  .app-container {
    display: grid;
    grid-template-columns: 300px 1fr;
    height: 100vh;
    overflow: hidden;
  }

  /* ===== SIDEBAR ===== */
  .sidebar {
    background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
    color: white;
    padding: 25px 20px;
    display: flex;
    flex-direction: column;
    box-shadow: 3px 0 15px rgba(0, 0, 0, 0.2);
    z-index: 100;
  }

  .logo {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 2px solid rgba(255, 255, 255, 0.1);
  }

  .logo-icon {
    font-size: 28px;
    background: linear-gradient(135deg, #3498db, #2ecc71);
    width: 40px;
    height: 40px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .logo-text {
    font-size: 20px;
    font-weight: 700;
    letter-spacing: 0.5px;
  }

  .logo-subtext {
    font-size: 12px;
    opacity: 0.8;
    margin-top: 2px;
  }

  /* Navigation */
  .nav-section {
    margin-bottom: 30px;
  }

  .nav-title {
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: #95a5a6;
    margin-bottom: 15px;
    font-weight: 600;
  }

  .nav-item {
    background: rgba(255, 255, 255, 0.08);
    padding: 14px 18px;
    border-radius: 10px;
    margin-bottom: 10px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 12px;
    transition: all 0.3s ease;
    border: 2px solid transparent;
    font-weight: 500;
  }

  .nav-item:hover {
    background: rgba(255, 255, 255, 0.15);
    transform: translateX(5px);
  }

  .nav-item.active {
    background: rgba(52, 152, 219, 0.2);
    border-color: #3498db;
    box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
  }

  .nav-icon {
    font-size: 18px;
    width: 24px;
    text-align: center;
  }

  /* Generated Pages */
  .pages-list {
    flex: 1;
    overflow-y: auto;
    padding-right: 10px;
  }

  .pages-list::-webkit-scrollbar {
    width: 6px;
  }

  .pages-list::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 3px;
  }

  .pages-list::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 3px;
  }

  .page-item {
    background: rgba(255, 255, 255, 0.08);
    margin-bottom: 10px;
    padding: 16px;
    border-radius: 10px;
    cursor: pointer;
    border: 2px solid transparent;
    transition: all 0.3s;
    position: relative;
    animation: slideIn 0.3s ease-out;
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateX(-20px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  .page-item:hover {
    background: rgba(255, 255, 255, 0.15);
    transform: translateY(-2px);
  }

  .page-item.active {
    border-color: #3498db;
    background: rgba(52, 152, 219, 0.15);
  }

  .page-title {
    font-weight: 600;
    margin-bottom: 5px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .page-tag {
    background: rgba(52, 152, 219, 0.2);
    color: #3498db;
    padding: 3px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
  }

  .page-date {
    font-size: 12px;
    color: #95a5a6;
  }

  .delete-page {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: rgba(231, 76, 60, 0.2);
    color: #e74c3c;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.2s;
    opacity: 0;
  }

  .page-item:hover .delete-page {
    opacity: 1;
  }

  .delete-page:hover {
    background: rgba(231, 76, 60, 0.3);
    transform: scale(1.1);
  }

  /* ===== MAIN CONTENT ===== */
  .main-content {
    padding: 30px 40px;
    overflow-y: auto;
    background: white;
    position: relative;
  }

  .main-header {
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 2px solid #ecf0f1;
  }

  .main-title {
    font-size: 32px;
    font-weight: 800;
    color: #2c3e50;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 15px;
  }

  .main-subtitle {
    color: #7f8c8d;
    font-size: 16px;
    max-width: 800px;
  }

  /* Configuration Panel */
  .config-panel {
    background: white;
    border-radius: 15px;
    padding: 0;
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
    margin-bottom: 30px;
    overflow: hidden;
  }

  .panel-header {
    background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
    color: white;
    padding: 25px 30px;
  }

  .panel-title {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 10px;
  }

  .panel-subtitle {
    opacity: 0.9;
    font-size: 15px;
  }

  .panel-body {
    padding: 30px;
  }

  /* Level Containers */
  .level-container {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 25px;
    border-left: 5px solid #3498db;
    transition: transform 0.3s;
  }

  .level-container:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
  }

  .level-header {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid #ecf0f1;
  }

  .level-number {
    background: #3498db;
    color: white;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 18px;
  }

  .level-title {
    font-size: 20px;
    font-weight: 700;
    color: #2c3e50;
  }

  .level-description {
    color: #7f8c8d;
    font-size: 14px;
    margin-top: 5px;
  }

  /* Form Controls */
  .control-group {
    margin-bottom: 25px;
  }

  .control-label {
    display: block;
    margin-bottom: 10px;
    font-weight: 600;
    color: #2c3e50;
    font-size: 15px;
  }

  .control-label.required::after {
    content: " *";
    color: #e74c3c;
    font-weight: bold;
  }

  select, input[type="text"], input[type="number"], input[type="email"], input[type="date"] {
    width: 100%;
    max-width: 500px;
    padding: 14px 18px;
    border: 2px solid #dfe6e9;
    border-radius: 10px;
    font-size: 15px;
    transition: all 0.3s;
    background: white;
  }

  select:focus, input:focus {
    outline: none;
    border-color: #3498db;
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
  }

  select.error, input.error {
    border-color: #e74c3c;
    background: #fff5f5;
  }

  .error-message {
    color: #e74c3c;
    font-size: 13px;
    margin-top: 8px;
    display: none;
    padding: 10px;
    background: #fff5f5;
    border-radius: 8px;
    border-left: 3px solid #e74c3c;
  }

  .error-message.show {
    display: block;
    animation: fadeIn 0.3s;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-5px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Checkbox and Radio Groups */
  .checkbox-group, .radio-group {
    background: white;
    border-radius: 10px;
    padding: 20px;
    border: 2px solid #dfe6e9;
  }

  .checkbox-group.error, .radio-group.error {
    border-color: #e74c3c;
    background: #fff5f5;
  }

  .option-item {
    display: flex;
    align-items: center;
    padding: 12px;
    margin-bottom: 8px;
    border-radius: 8px;
    transition: all 0.2s;
    cursor: pointer;
  }

  .option-item:hover {
    background: #f8f9fa;
  }

  .option-item input {
    margin-right: 12px;
    transform: scale(1.2);
  }

  /* Page Selection */
  .page-selection-container {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 25px;
    margin: 30px 0;
    border: 2px dashed #3498db;
  }

  .page-selection-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
  }

  .page-selection-title {
    font-size: 20px;
    font-weight: 700;
    color: #2c3e50;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .page-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 20px;
  }

  .page-card {
    background: white;
    border-radius: 12px;
    padding: 25px;
    border: 2px solid #dfe6e9;
    cursor: pointer;
    transition: all 0.3s;
    position: relative;
  }

  .page-card:hover {
    border-color: #3498db;
    transform: translateY(-3px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
  }

  .page-card.selected {
    border-color: #2ecc71;
    background: #f9fffb;
  }

  .page-card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 15px;
  }

  .page-card-checkbox {
    width: 20px;
    height: 20px;
    border-radius: 6px;
    border: 2px solid #bdc3c7;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }

  .page-card.selected .page-card-checkbox {
    background: #2ecc71;
    border-color: #2ecc71;
  }

  .page-card.selected .page-card-checkbox::after {
    content: "‚úì";
    color: white;
    font-weight: bold;
  }

  .page-card-title {
    font-size: 18px;
    font-weight: 700;
    color: #2c3e50;
    margin-bottom: 8px;
  }

  .page-card-desc {
    color: #7f8c8d;
    font-size: 14px;
    line-height: 1.5;
  }

  /* Buttons */
  .action-buttons {
    display: flex;
    gap: 15px;
    margin-top: 30px;
    padding-top: 25px;
    border-top: 2px solid #ecf0f1;
  }

  .btn {
    padding: 15px 30px;
    border-radius: 10px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    border: none;
    display: flex;
    align-items: center;
    gap: 10px;
    min-width: 180px;
  }

  .btn-primary {
    background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
    color: white;
  }

  .btn-primary:hover {
    background: linear-gradient(135deg, #2980b9 0%, #2573a7 100%);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
  }

  .btn-secondary {
    background: #ecf0f1;
    color: #2c3e50;
  }

  .btn-secondary:hover {
    background: #dfe6e9;
    transform: translateY(-2px);
  }

  .btn-success {
    background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
    color: white;
  }

  .btn-success:hover {
    background: linear-gradient(135deg, #27ae60 0%, #219653 100%);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(46, 204, 113, 0.4);
  }

  .btn-icon {
    font-size: 18px;
  }

  /* Generated Pages View */
  .pages-view {
    display: none;
  }

  .pages-view.active {
    display: block;
  }

  .pages-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 25px;
    margin-top: 30px;
  }

  .generated-page-card {
    background: white;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
    transition: all 0.3s;
    cursor: pointer;
  }

  .generated-page-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
  }

  .generated-page-header {
    background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
    color: white;
    padding: 20px;
  }

  .generated-page-title {
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 5px;
  }

  .generated-page-type {
    font-size: 12px;
    opacity: 0.9;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .generated-page-body {
    padding: 20px;
  }

  .generated-page-info {
    display: flex;
    justify-content: space-between;
    margin-bottom: 15px;
    font-size: 14px;
    color: #7f8c8d;
  }

  .generated-page-stats {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 15px;
    font-size: 14px;
  }

  .stat-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
  }

  .stat-value {
    font-weight: 600;
    color: #2c3e50;
  }

  /* Loading Spinner */
  .loading-spinner {
    display: none;
    text-align: center;
    padding: 60px;
  }

  .loading-spinner.active {
    display: block;
  }

  .spinner {
    width: 60px;
    height: 60px;
    border: 5px solid #ecf0f1;
    border-top: 5px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  /* Toast Notifications */
  .toast {
    position: fixed;
    bottom: 30px;
    right: 30px;
    background: white;
    padding: 20px 25px;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    transform: translateY(100px);
    opacity: 0;
    transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    z-index: 1000;
    max-width: 400px;
    display: flex;
    align-items: center;
    gap: 15px;
    border-left: 5px solid #3498db;
  }

  .toast.show {
    transform: translateY(0);
    opacity: 1;
  }

  .toast.success {
    border-left-color: #2ecc71;
  }

  .toast.error {
    border-left-color: #e74c3c;
  }

  .toast.info {
    border-left-color: #3498db;
  }

  .toast-icon {
    font-size: 24px;
  }

  .toast-message {
    flex: 1;
    font-weight: 600;
  }

  /* Responsive Design */
  @media (max-width: 1200px) {
    .app-container {
      grid-template-columns: 250px 1fr;
    }
    
    .main-content {
      padding: 25px;
    }
  }

  @media (max-width: 768px) {
    .app-container {
      grid-template-columns: 1fr;
      grid-template-rows: auto 1fr;
    }
    
    .sidebar {
      max-height: 300px;
      overflow-y: auto;
    }
    
    .page-grid {
      grid-template-columns: 1fr;
    }
    
    .action-buttons {
      flex-direction: column;
    }
    
    .btn {
      width: 100%;
      justify-content: center;
    }
  }
</style>
</head>

<body>
<div class="app-container">
  
  <!-- LEFT PANEL - SIDEBAR -->
  <div class="sidebar">
    <div class="logo">
      <div class="logo-icon">üìä</div>
      <div>
        <div class="logo-text">Dashboard Generator</div>
        <div class="logo-subtext">JSON-Driven Configuration</div>
      </div>
    </div>

    <div class="nav-section">
      <div class="nav-title">Navigation</div>
      <div class="nav-item active" id="configNav" onclick="showConfiguration()">
        <div class="nav-icon">‚öôÔ∏è</div>
        Configuration
      </div>
      <div class="nav-item" id="pagesNav" onclick="showGeneratedPages()">
        <div class="nav-icon">üìÑ</div>
        Generated Pages
      </div>
    </div>

    <div class="nav-section">
      <div class="nav-title">Recent Pages</div>
      <div class="pages-list" id="pagesList">
        <!-- Pages will be dynamically added here -->
      </div>
    </div>

    <div style="margin-top: auto; padding-top: 20px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
      <div style="font-size: 12px; color: #95a5a6; text-align: center;">
        v2.0.0 ‚Ä¢ JSON-Driven
      </div>
    </div>
  </div>

  <!-- MAIN CONTENT -->
  <div class="main-content" id="contentArea">
    
    <!-- Configuration View -->
    <div id="configurationView">
      <div class="main-header">
        <h1 class="main-title">
          <span>üìã Configuration Panel</span>
        </h1>
        <div class="main-subtitle">
          Configure your dashboard settings through multiple levels and select which pages to generate.
          <span style="color: #e74c3c; font-weight: 600;">*</span> indicates mandatory fields.
        </div>
      </div>

      <div class="config-panel">
        <div class="panel-header">
          <div class="panel-title">Multi-Level Configuration</div>
          <div class="panel-subtitle">Complete all levels to unlock page generation</div>
        </div>

        <div class="panel-body">
          <!-- Level 1: Configuration Type -->
          <div class="level-container" id="level1-container">
            <div class="level-header">
              <div class="level-number">1</div>
              <div>
                <div class="level-title">Configuration Type</div>
                <div class="level-description">Select the type of dashboard you want to configure</div>
              </div>
            </div>

            <div class="control-group">
              <label class="control-label required">Select configuration type</label>
              <select id="level1">
                <option value="">‚Äî Please select ‚Äî</option>
                <!-- Options will be populated dynamically -->
              </select>
              <div class="error-message" id="level1-error">Please select a configuration type</div>
            </div>
          </div>

          <!-- Dynamic Levels Container -->
          <div id="levelsContainer"></div>

          <!-- Page Selection (appears after level 4) -->
          <div id="pageSelectionContainer" style="display: none;">
            <div class="page-selection-container">
              <div class="page-selection-header">
                <div class="page-selection-title">
                  <span>üìÑ Select Pages to Generate</span>
                </div>
                <div style="display: flex; gap: 10px;">
                  <button class="btn btn-secondary" onclick="selectAllPages()" style="padding: 8px 16px; font-size: 14px;">
                    Select All
                  </button>
                  <button class="btn btn-secondary" onclick="deselectAllPages()" style="padding: 8px 16px; font-size: 14px;">
                    Deselect All
                  </button>
                </div>
              </div>
              <div class="page-grid" id="pagesGrid">
                <!-- Pages will be dynamically added here -->
              </div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="action-buttons">
            <button class="btn btn-primary" onclick="generatePages()">
              <span class="btn-icon">üöÄ</span>
              Generate Selected Pages
            </button>
            <button class="btn btn-secondary" onclick="resetConfiguration()">
              <span class="btn-icon">üîÑ</span>
              Reset Configuration
            </button>
            <button class="btn btn-success" onclick="saveConfiguration()" style="display: none;" id="saveConfigBtn">
              <span class="btn-icon">üíæ</span>
              Save Configuration
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Generated Pages View -->
    <div id="pagesView" class="pages-view">
      <div class="main-header">
        <h1 class="main-title">
          <span>üìÑ Generated Pages</span>
        </h1>
        <div class="main-subtitle">
          Browse through all generated dashboard pages. Click on any page to view its details.
        </div>
      </div>

      <div id="pagesContainer">
        <!-- Generated pages will be displayed here -->
      </div>
    </div>

    <!-- Loading Spinner -->
    <div class="loading-spinner" id="loadingSpinner">
      <div class="spinner"></div>
      <p>Loading configuration...</p>
    </div>
  </div>
</div>

<!-- Toast Notification -->
<div id="toast" class="toast" style="display: none;">
  <span id="toastIcon" class="toast-icon">‚úÖ</span>
  <span id="toastMessage" class="toast-message">Operation completed successfully</span>
</div>

<script>
// ==================== GLOBAL STATE ====================
const API_BASE = 'http://localhost:5000/api';
let globalConfig = null;
let currentConfigType = null;
let currentSelections = {};
let selectedPages = new Set();
let availablePages = [];
let generatedPages = [];

// ==================== INITIALIZATION ====================
async function initializeApp() {
  showLoading(true);
  
  try {
    // Load global configuration
    const response = await fetch(`${API_BASE}/config`);
    if (!response.ok) throw new Error('Failed to load configuration');
    
    globalConfig = await response.json();
    setupLevel1();
    
    // Load generated pages
    await loadGeneratedPages();
    
    showToast('Configuration loaded successfully', 'success');
  } catch (error) {
    console.error('Initialization error:', error);
    showToast('Failed to load configuration', 'error');
  } finally {
    showLoading(false);
  }
}

function setupLevel1() {
  const level1Select = document.getElementById('level1');
  level1Select.innerHTML = '<option value="">‚Äî Please select ‚Äî</option>';
  
  for (const [key, config] of Object.entries(globalConfig)) {
    const option = document.createElement('option');
    option.value = key;
    option.textContent = `${config.title} - ${config.description}`;
    level1Select.appendChild(option);
  }
  
  level1Select.addEventListener('change', handleLevel1Change);
}

async function handleLevel1Change(event) {
  currentConfigType = event.target.value;
  currentSelections = {};
  selectedPages.clear();
  
  if (!currentConfigType) {
    clearLevels(2);
    hidePageSelection();
    return;
  }
  
  // Reset error state
  event.target.classList.remove('error');
  document.getElementById('level1-error').classList.remove('show');
  
  // Clear previous levels
  clearLevels(2);
  
  // Load available pages for this config type
  await loadAvailablePages(currentConfigType);
  
  // Load level 2 configuration
  const config = globalConfig[currentConfigType];
  if (config.levels && config.levels.level2) {
    renderLevel('level2', config.levels.level2);
  }
  
  // Show save button
  document.getElementById('saveConfigBtn').style.display = 'flex';
}

// ==================== LEVEL RENDERING ====================
function renderLevel(levelKey, levelConfig) {
  const container = document.getElementById('levelsContainer');
  const levelDiv = document.createElement('div');
  levelDiv.className = 'level-container';
  levelDiv.id = `${levelKey}-container`;
  
  const levelNum = parseInt(levelKey.replace('level', ''));
  
  levelDiv.innerHTML = `
    <div class="level-header">
      <div class="level-number">${levelNum}</div>
      <div>
        <div class="level-title">${levelConfig.title}</div>
        <div class="level-description">${levelConfig.description || ''}</div>
      </div>
    </div>
  `;
  
  const controlGroup = document.createElement('div');
  controlGroup.className = 'control-group';
  
  const label = document.createElement('label');
  label.className = `control-label ${levelConfig.mandatory ? 'required' : ''}`;
  label.textContent = levelConfig.label;
  label.htmlFor = levelConfig.id;
  controlGroup.appendChild(label);
  
  const errorMsg = document.createElement('div');
  errorMsg.className = 'error-message';
  errorMsg.id = `${levelConfig.id}-error`;
  errorMsg.textContent = `Please fill in "${levelConfig.label}"`;
  
  if (levelConfig.type === 'dropdown') {
    const select = document.createElement('select');
    select.id = levelConfig.id;
    
    const defaultOption = document.createElement('option');
    defaultOption.value = '';
    defaultOption.textContent = '‚Äî Select ‚Äî';
    select.appendChild(defaultOption);
    
    levelConfig.values.forEach(value => {
      const option = document.createElement('option');
      option.value = value;
      option.textContent = value;
      select.appendChild(option);
    });
    
    select.addEventListener('change', (e) => handleLevelChange(levelKey, levelConfig, e.target.value));
    controlGroup.appendChild(select);
    
  } else if (levelConfig.type === 'checkbox') {
    const checkboxGroup = document.createElement('div');
    checkboxGroup.className = 'checkbox-group';
    
    levelConfig.options.forEach(option => {
      const optionDiv = document.createElement('div');
      optionDiv.className = 'option-item';
      
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.id = `${levelConfig.id}_${option.value}`;
      checkbox.value = option.value;
      
      const label = document.createElement('label');
      label.htmlFor = checkbox.id;
      label.textContent = option.label;
      label.style.marginLeft = '10px';
      label.style.cursor = 'pointer';
      
      optionDiv.appendChild(checkbox);
      optionDiv.appendChild(label);
      checkboxGroup.appendChild(optionDiv);
      
      checkbox.addEventListener('change', () => {
        const checkboxes = checkboxGroup.querySelectorAll('input[type="checkbox"]');
        const selectedValues = Array.from(checkboxes)
          .filter(cb => cb.checked)
          .map(cb => cb.value);
        
        handleLevelChange(levelKey, levelConfig, selectedValues);
      });
    });
    
    controlGroup.appendChild(checkboxGroup);
  }
  
  controlGroup.appendChild(errorMsg);
  levelDiv.appendChild(controlGroup);
  container.appendChild(levelDiv);
}

function handleLevelChange(levelKey, levelConfig, value) {
  const levelNum = parseInt(levelKey.replace('level', ''));
  currentSelections[levelKey] = value;
  
  // Clear subsequent levels
  clearLevels(levelNum + 1);
  
  // Hide page selection
  hidePageSelection();
  
  // Validate current level
  validateLevel(levelKey, levelConfig, value);
  
  // Check if we need to render next level
  if (levelConfig.nextLevels) {
    if (levelConfig.type === 'dropdown' && levelConfig.nextLevels[value]) {
      const nextLevelKey = `level${levelNum + 1}`;
      const nextLevelConfig = levelConfig.nextLevels[value][nextLevelKey];
      if (nextLevelConfig) {
        renderLevel(nextLevelKey, nextLevelConfig);
      }
    } else if (levelConfig.type === 'checkbox' && Array.isArray(value) && value.length > 0) {
      if (levelConfig.nextLevels.selected) {
        const nextLevelKey = `level${levelNum + 1}`;
        const nextLevelConfig = levelConfig.nextLevels.selected[nextLevelKey];
        if (nextLevelConfig) {
          renderLevel(nextLevelKey, nextLevelConfig);
        }
      }
    }
  }
  
  // If this is the last level, show page selection
  if (levelConfig.isLastLevel) {
    showPageSelection();
  }
}

function validateLevel(levelKey, levelConfig, value) {
  const control = document.getElementById(levelConfig.id);
  const errorMsg = document.getElementById(`${levelConfig.id}-error`);
  
  if (!levelConfig.mandatory) return true;
  
  let isValid = false;
  
  if (levelConfig.type === 'dropdown') {
    isValid = value && value !== '';
    if (control) control.classList.toggle('error', !isValid);
  } else if (levelConfig.type === 'checkbox') {
    isValid = Array.isArray(value) && value.length > 0;
    const checkboxGroup = control ? control.closest('.checkbox-group') : null;
    if (checkboxGroup) checkboxGroup.classList.toggle('error', !isValid);
  }
  
  if (errorMsg) errorMsg.classList.toggle('show', !isValid);
  
  return isValid;
}

function clearLevels(startFrom) {
  for (let i = startFrom; i <= 4; i++) {
    const container = document.getElementById(`level${i}-container`);
    if (container) container.remove();
    delete currentSelections[`level${i}`];
  }
}

// ==================== PAGE SELECTION ====================
async function loadAvailablePages(configType) {
  try {
    const response = await fetch(`${API_BASE}/pages/${configType}`);
    if (response.ok) {
      availablePages = await response.json();
    }
  } catch (error) {
    console.error('Error loading pages:', error);
  }
}

function showPageSelection() {
  const container = document.getElementById('pageSelectionContainer');
  const grid = document.getElementById('pagesGrid');
  
  if (!container || !grid) return;
  
  grid.innerHTML = '';
  
  availablePages.forEach(page => {
    const pageCard = document.createElement('div');
    pageCard.className = `page-card ${selectedPages.has(page.id) ? 'selected' : ''}`;
    pageCard.onclick = () => togglePageSelection(page.id, pageCard);
    
    pageCard.innerHTML = `
      <div class="page-card-header">
        <div class="page-card-checkbox"></div>
        <span style="font-size: 12px; color: #7f8c8d; background: #f1f2f6; padding: 4px 10px; border-radius: 12px;">
          ${page.requirements ? Object.keys(page.requirements).length : 0} requirements
        </span>
      </div>
      <div class="page-card-title">${page.name}</div>
      <div class="page-card-desc">${page.description}</div>
    `;
    
    grid.appendChild(pageCard);
  });
  
  container.style.display = 'block';
}

function hidePageSelection() {
  const container = document.getElementById('pageSelectionContainer');
  if (container) container.style.display = 'none';
}

function togglePageSelection(pageId, element) {
  if (selectedPages.has(pageId)) {
    selectedPages.delete(pageId);
    element.classList.remove('selected');
  } else {
    selectedPages.add(pageId);
    element.classList.add('selected');
  }
}

function selectAllPages() {
  selectedPages.clear();
  availablePages.forEach(page => selectedPages.add(page.id));
  
  document.querySelectorAll('.page-card').forEach(card => {
    card.classList.add('selected');
  });
}

function deselectAllPages() {
  selectedPages.clear();
  document.querySelectorAll('.page-card').forEach(card => {
    card.classList.remove('selected');
  });
}

// ==================== VALIDATION ====================
function validateConfiguration() {
  let isValid = true;
  
  // Validate level 1
  const level1Select = document.getElementById('level1');
  if (!currentConfigType) {
    level1Select.classList.add('error');
    document.getElementById('level1-error').classList.add('show');
    isValid = false;
  }
  
  // Validate other levels
  if (globalConfig && currentConfigType) {
    const config = globalConfig[currentConfigType];
    
    const validateLevelRecursive = (levelKey, levelConfig) => {
      if (!levelConfig) return;
      
      const value = currentSelections[levelKey];
      const levelValid = validateLevel(levelKey, levelConfig, value);
      if (!levelValid) isValid = false;
      
      // Check next levels
      if (levelConfig.nextLevels && levelConfig.type === 'dropdown' && value) {
        if (levelConfig.nextLevels[value]) {
          const nextLevelKey = `level${parseInt(levelKey.replace('level', '')) + 1}`;
          const nextLevelConfig = levelConfig.nextLevels[value][nextLevelKey];
          validateLevelRecursive(nextLevelKey, nextLevelConfig);
        }
      } else if (levelConfig.nextLevels && levelConfig.type === 'checkbox' && Array.isArray(value) && value.length > 0) {
        if (levelConfig.nextLevels.selected) {
          const nextLevelKey = `level${parseInt(levelKey.replace('level', '')) + 1}`;
          const nextLevelConfig = levelConfig.nextLevels.selected[nextLevelKey];
          validateLevelRecursive(nextLevelKey, nextLevelConfig);
        }
      }
    };
    
    if (config.levels && config.levels.level2) {
      validateLevelRecursive('level2', config.levels.level2);
    }
  }
  
  // Validate page selection
  if (selectedPages.size === 0) {
    showToast('Please select at least one page to generate', 'error');
    isValid = false;
  }
  
  return isValid;
}

// ==================== GENERATION ====================
async function generatePages() {
  if (!validateConfiguration()) return;
  
  showLoading(true);
  
  try {
    const payload = {
      configType: currentConfigType,
      selections: currentSelections,
      selectedPages: Array.from(selectedPages)
    };
    
    const response = await fetch(`${API_BASE}/generate`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    
    if (!response.ok) throw new Error('Generation failed');
    
    const result = await response.json();
    
    if (result.success) {
      showToast(`Successfully generated ${result.generated_count} pages`, 'success');
      
      // Add generated pages to list
      result.pages.forEach(page => {
        generatedPages.unshift({
          id: page.id,
          name: page.name,
          generated_page: page.generated_page,
          timestamp: new Date().toISOString()
        });
      });
      
      // Update pages list in sidebar
      updatePagesList();
      
      // Switch to pages view
      showGeneratedPages();
    } else {
      showToast(result.error || 'Generation failed', 'error');
    }
  } catch (error) {
    console.error('Generation error:', error);
    showToast('Failed to generate pages', 'error');
  } finally {
    showLoading(false);
  }
}

async function saveConfiguration() {
  if (!validateConfiguration()) return;
  
  try {
    const configData = {
      name: `Config_${currentConfigType}_${new Date().toISOString().slice(0, 10)}`,
      type: currentConfigType,
      selections: currentSelections,
      selectedPages: Array.from(selectedPages),
      savedAt: new Date().toISOString()
    };
    
    // In a real app, you would save this to a backend
    localStorage.setItem(`config_${Date.now()}`, JSON.stringify(configData));
    showToast('Configuration saved locally', 'success');
  } catch (error) {
    console.error('Save error:', error);
    showToast('Failed to save configuration', 'error');
  }
}

// ==================== PAGES MANAGEMENT ====================
async function loadGeneratedPages() {
  try {
    const response = await fetch(`${API_BASE}/generated-pages`);
    if (response.ok) {
      const data = await response.json();
      generatedPages = data.pages || [];
      updatePagesList();
    }
  } catch (error) {
    console.error('Error loading pages:', error);
    // Load from localStorage as fallback
    loadPagesFromLocalStorage();
  }
}

function loadPagesFromLocalStorage() {
  generatedPages = [];
  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    if (key.startsWith('generated_page_')) {
      try {
        const page = JSON.parse(localStorage.getItem(key));
        generatedPages.push(page);
      } catch (e) {
        console.error('Error parsing page:', e);
      }
    }
  }
  updatePagesList();
}

function updatePagesList() {
  const pagesList = document.getElementById('pagesList');
  if (!pagesList) return;
  
  pagesList.innerHTML = '';
  
  // Show only last 10 pages
  const recentPages = generatedPages.slice(0, 10);
  
  recentPages.forEach(page => {
    const pageItem = document.createElement('div');
    pageItem.className = 'page-item';
    pageItem.onclick = () => viewPage(page.id);
    
    const date = new Date(page.timestamp || page.generated_page?.generated_at);
    const dateStr = `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth()+1).toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
    
    pageItem.innerHTML = `
      <div class="delete-page" onclick="deletePage('${page.id}', event)">√ó</div>
      <div class="page-title">
        ${page.name || page.generated_page?.title || 'Unnamed Page'}
        <span class="page-tag">${page.generated_page?.source_config || 'unknown'}</span>
      </div>
      <div class="page-date">${dateStr}</div>
    `;
    
    pagesList.appendChild(pageItem);
  });
}

function viewPage(pageId) {
  const page = generatedPages.find(p => p.id === pageId);
  if (!page) return;
  
  showGeneratedPages();
  
  const container = document.getElementById('pagesContainer');
  container.innerHTML = `
    <div class="config-panel">
      <div class="panel-header">
        <div class="panel-title">${page.name || page.generated_page?.title}</div>
        <div class="panel-subtitle">Generated on ${new Date(page.timestamp || page.generated_page?.generated_at).toLocaleString()}</div>
      </div>
      <div class="panel-body">
        <div class="level-container">
          <div class="level-header">
            <div class="level-number">üìä</div>
            <div>
              <div class="level-title">Page Information</div>
              <div class="level-description">Details about this generated page</div>
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; margin-top: 20px;">
            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
              <div style="font-size: 14px; color: #7f8c8d; margin-bottom: 5px;">Type</div>
              <div style="font-weight: 600; font-size: 18px;">${page.generated_page?.type || 'dashboard'}</div>
            </div>
            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
              <div style="font-size: 14px; color: #7f8c8d; margin-bottom: 5px;">Source Config</div>
              <div style="font-weight: 600; font-size: 18px;">${page.generated_page?.source_config || 'unknown'}</div>
            </div>
            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
              <div style="font-size: 14px; color: #7f8c8d; margin-bottom: 5px;">Components</div>
              <div style="font-weight: 600; font-size: 18px;">${page.generated_page?.components?.length || 0}</div>
            </div>
          </div>
        </div>
        
        ${page.generated_page?.components?.map(comp => `
          <div class="level-container" style="margin-top: 25px;">
            <div class="level-header">
              <div class="level-number">${comp.type === 'chart' ? 'üìà' : comp.type === 'table' ? 'üìã' : 'üìä'}</div>
              <div>
                <div class="level-title">${comp.title}</div>
                <div class="level-description">${comp.type} component</div>
              </div>
            </div>
            
            <div style="background: white; border-radius: 10px; padding: 25px; margin-top: 20px; border: 2px solid #ecf0f1;">
              <div id="comp-${comp.id}"></div>
            </div>
          </div>
        `).join('') || '<div class="level-container"><p>No components available</p></div>'}
        
        ${page.generated_page?.selections_applied ? `
          <div class="level-container">
            <div class="level-header">
              <div class="level-number">‚öôÔ∏è</div>
              <div>
                <div class="level-title">Applied Selections</div>
                <div class="level-description">Configuration used to generate this page</div>
              </div>
            </div>
            <div style="background: #f8f9fa; border-radius: 10px; padding: 20px; margin-top: 20px;">
              <pre style="font-family: monospace; font-size: 13px; overflow: auto; max-height: 300px;">${JSON.stringify(page.generated_page.selections_applied, null, 2)}</pre>
            </div>
          </div>
        ` : ''}
      </div>
    </div>
  `;
}

function deletePage(pageId, event) {
  if (event) event.stopPropagation();
  
  if (!confirm('Are you sure you want to delete this page?\nThis action cannot be undone.')) {
    return;
  }
  
  generatedPages = generatedPages.filter(p => p.id !== pageId);
  updatePagesList();
  
  // Remove from localStorage
  localStorage.removeItem(`generated_page_${pageId}`);
  
  showToast('Page deleted successfully', 'success');
}

// ==================== VIEW MANAGEMENT ====================
function showConfiguration() {
  document.getElementById('configurationView').style.display = 'block';
  document.getElementById('pagesView').classList.remove('active');
  
  document.getElementById('configNav').classList.add('active');
  document.getElementById('pagesNav').classList.remove('active');
}

function showGeneratedPages() {
  document.getElementById('configurationView').style.display = 'none';
  document.getElementById('pagesView').classList.add('active');
  
  document.getElementById('configNav').classList.remove('active');
  document.getElementById('pagesNav').classList.add('active');
  
  displayAllPages();
}

function displayAllPages() {
  const container = document.getElementById('pagesContainer');
  
  if (generatedPages.length === 0) {
    container.innerHTML = `
      <div class="config-panel">
        <div class="panel-body" style="text-align: center; padding: 60px;">
          <div style="font-size: 64px; color: #bdc3c7; margin-bottom: 20px;">üìÑ</div>
          <h3 style="color: #2c3e50; margin-bottom: 15px;">No Pages Generated Yet</h3>
          <p style="color: #7f8c8d; max-width: 500px; margin: 0 auto 30px;">
            You haven't generated any pages yet. Configure your dashboard and generate some pages to see them here.
          </p>
          <button class="btn btn-primary" onclick="showConfiguration()">
            <span class="btn-icon">‚öôÔ∏è</span>
            Go to Configuration
          </button>
        </div>
      </div>
    `;
    return;
  }
  
  container.innerHTML = `
    <div class="pages-grid">
      ${generatedPages.map(page => {
        const date = new Date(page.timestamp || page.generated_page?.generated_at);
        const dateStr = date.toLocaleDateString();
        const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        
        return `
          <div class="generated-page-card" onclick="viewPage('${page.id}')">
            <div class="generated-page-header">
              <div class="generated-page-title">${page.name || page.generated_page?.title || 'Unnamed Page'}</div>
              <div class="generated-page-type">${page.generated_page?.type || 'dashboard'}</div>
            </div>
            <div class="generated-page-body">
              <div class="generated-page-info">
                <span>${dateStr}</span>
                <span>${timeStr}</span>
              </div>
              <div class="generated-page-stats">
                <div class="stat-item">
                  <span>Type:</span>
                  <span class="stat-value">${page.generated_page?.source_config || 'unknown'}</span>
                </div>
                <div class="stat-item">
                  <span>Components:</span>
                  <span class="stat-value">${page.generated_page?.components?.length || 0}</span>
                </div>
                <div class="stat-item">
                  <span>Generated:</span>
                  <span class="stat-value">${dateStr} ${timeStr}</span>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('')}
    </div>
  `;
}

// ==================== UTILITY FUNCTIONS ====================
function resetConfiguration() {
  if (!confirm('Are you sure you want to reset the configuration?\nAll current selections will be lost.')) {
    return;
  }
  
  currentConfigType = null;
  currentSelections = {};
  selectedPages.clear();
  
  document.getElementById('level1').value = '';
  clearLevels(2);
  hidePageSelection();
  
  document.getElementById('saveConfigBtn').style.display = 'none';
  
  showToast('Configuration reset successfully', 'info');
}

function showLoading(show) {
  const spinner = document.getElementById('loadingSpinner');
  if (show) {
    spinner.classList.add('active');
  } else {
    spinner.classList.remove('active');
  }
}

function showToast(message, type = 'info') {
  const toast = document.getElementById('toast');
  const icon = document.getElementById('toastIcon');
  const toastMessage = document.getElementById('toastMessage');
  
  toast.className = `toast ${type}`;
  toastMessage.textContent = message;
  
  switch(type) {
    case 'success':
      icon.textContent = '‚úÖ';
      break;
    case 'error':
      icon.textContent = '‚ùå';
      break;
    case 'info':
      icon.textContent = '‚ÑπÔ∏è';
      break;
    case 'warning':
      icon.textContent = '‚ö†Ô∏è';
      break;
  }
  
  toast.style.display = 'flex';
  setTimeout(() => {
    toast.classList.add('show');
  }, 10);
  
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => {
      toast.style.display = 'none';
    }, 500);
  }, 3000);
}

// ==================== INITIALIZATION ====================
document.addEventListener('DOMContentLoaded', () => {
  initializeApp();
  
  // Set up navigation
  document.getElementById('configNav').addEventListener('click', showConfiguration);
  document.getElementById('pagesNav').addEventListener('click', showGeneratedPages);
});
</script>
</body>
</html>